<header class="navbar bg-blue-700 text-white shadow-lg p-4">
    <div class="container mx-auto flex justify-between items-center">
        <div class="flex-1">
            <a href="{% url 'presentacion:home' %}"
               class="btn btn-ghost text-2xl font-semibold hover:text-white">Global Exchange</a>
        </div>
        <div class="flex-none">
            <!-- Mobile menu button -->
            <button class="btn btn-ghost lg:hidden"
                    onclick="document.getElementById('sidebar_menu').showModal()">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="h-6 w-6"
                     fill="none"
                     viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <!-- Desktop menu - only dropdown for all users -->
            {% if request.user.is_authenticated %}
                <div class="hidden lg:flex">
                    <details class="dropdown dropdown-end">
                        <summary class="btn btn-ghost rounded-btn m-1 hover:text-white flex items-center whitespace-nowrap max-w-xs overflow-hidden">
                            <span class="mr-2 truncate text-white">
                                {{ request.user.nombre|default:'Usuario' }}
                                {% if request.cliente %}({{ request.cliente.nombre }}){% endif %}
                            </span>
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 class="h-5 w-5 text-white"
                                 viewBox="0 0 20 20"
                                 fill="currentColor">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                            </svg>
                        </summary>
                        <ul class="menu dropdown-content bg-base-100 text-neutral rounded-box z-10 min-w-[240px] w-auto p-2 shadow-lg">
                            <!-- Client-related options only if user has clients -->
                            {% if user_has_clients %}
                                <li>
                                    <a href="{% url 'transacciones:lista' %}" class="hover:bg-neutral-200">Mis transacciones</a>
                                </li>
                                <li>
                                    <a href="{% url 'transacciones:realizar_transaccion' %}"
                                       class="hover:bg-neutral-200">Realizar Transacción</a>
                                </li>
                                <li class="border-t border-neutral-content mt-2 pt-2"></li>
                            {% endif %}
                            <li>
                                <a href="{% url 'transacciones:simular_cambio' %}"
                                   class="hover:bg-neutral-200">Simulador</a>
                            </li>
                            <li>
                                <a class="hover:bg-neutral-200">Perfil</a>
                            </li>
                            <!-- Admin panel access for Administrators -->
                            {% if "Administrador" in user_groups %}
                                <li>
                                    <a href="{% url 'panel_inicio' %}"
                                       class="hover:bg-neutral-200 text-blue-600 font-semibold">
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                             class="w-4 h-4 mr-2"
                                             fill="none"
                                             viewBox="0 0 24 24"
                                             stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        Panel de Administración
                                    </a>
                                </li>
                            {% endif %}
                            {% if user_has_clients %}
                                <li>
                                    <a href="{% url 'transacciones:configuracion_medios_pago' %}"
                                       class="hover:bg-neutral-200">Configuración</a>
                                </li>
                                <!-- Selector de cliente -->
                                <li class="border-t border-neutral-content mt-2 pt-2">
                                    <div class="w-80">
                                        <select id="clienteSelector"
                                                name="cliente_id"
                                                class="select select-bordered w-60 text-black rounded-lg border-gray-300 shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            {% for c in request.user.clientes.all %}
                                                <option value="{{ c.id }}"
                                                        {% if request.cliente and request.cliente.id == c.id %}selected{% endif %}>
                                                    {{ c.nombre }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </li>
                            {% endif %}
                            <li class="border-t border-neutral-content mt-2 pt-2">
                                <a href="{% url 'seguridad:logout' %}" class="hover:bg-neutral-200">Cerrar Sesión</a>
                            </li>
                        </ul>
                    </details>
                </div>
            {% else %}
                <!-- Login button for non-authenticated users -->
                <div class="hidden lg:flex">
                    <a href="{% url 'seguridad:login' %}"
                       class="btn btn-ghost hover:text-white">Iniciar Sesión</a>
                </div>
            {% endif %}
        </div>
    </div>
</header>
{# Sidebar móvil (oculto en pantallas grandes) #}
<dialog id="sidebar_menu" class="modal">
    <div class="modal-box w-full max-w-xs p-0 rounded-lg shadow-lg bg-base-100 text-neutral">
        <form method="dialog">
            <button type="button"
                    class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
                    onclick="document.getElementById('sidebar_menu').close()">✕</button>
        </form>
        <nav class="menu p-4">
            {% if not request.user.is_authenticated %}
                <!-- Options for non-authenticated users -->
                <a href="{% url 'transacciones:simular_cambio' %}"
                   class="mb-3 block py-2 px-3 rounded hover:bg-neutral-200 transition">Simulador</a>
                <a href="{% url 'seguridad:login' %}"
                   class="mb-3 block py-2 px-3 rounded hover:bg-neutral-200 transition">Iniciar Sesión</a>
            {% else %}
                <!-- Options for authenticated users -->
                <!-- Client-dependent options -->
                {% if user_has_clients %}
                    <a href="{% url 'transacciones:lista' %}"
                       class="mb-3 block py-2 px-3 rounded hover:bg-neutral-200 transition">Mis transacciones</a>
                    <a href="{% url 'transacciones:realizar_transaccion' %}"
                       class="mb-3 block py-2 px-3 rounded hover:bg-neutral-200 transition">Realizar Transacción</a>
                {% else %}
                    <div class="mb-3 block py-2 px-3 rounded bg-gray-100 text-gray-500 cursor-not-allowed">
                        Mis transacciones
                        <div class="text-xs text-red-500">Necesita un cliente asociado para realizar la acción</div>
                    </div>
                    <div class="mb-3 block py-2 px-3 rounded bg-gray-100 text-gray-500 cursor-not-allowed">
                        Realizar Transacción
                        <div class="text-xs text-red-500">Necesita un cliente asociado para realizar la acción</div>
                    </div>
                {% endif %}
                <!-- Always available options for authenticated users -->
                <a href="{% url 'transacciones:simular_cambio' %}"
                   class="mb-3 block py-2 px-3 rounded hover:bg-neutral-200 transition">Simulador</a>
                <div class="border-t border-neutral-content my-3"></div>
                <!-- User info -->
                <div class="mb-3 flex items-center space-x-2">
                    <div class="w-8 h-8 rounded-full bg-blue-700 flex items-center justify-center text-white">
                        <span class="text-base font-bold">{{ request.user.nombre|default:'U'|first|upper }}</span>
                    </div>
                    <div>
                        <span class="font-semibold block">{{ request.user.nombre|default:'Usuario' }}</span>
                        {% if request.cliente %}<span class="text-xs block text-neutral-500">({{ request.cliente.nombre }})</span>{% endif %}
                    </div>
                </div>
                <!-- User account options -->
                <a href="#"
                   class="mb-3 block py-2 px-3 rounded hover:bg-neutral-200 transition">Perfil</a>
                <!-- Admin panel access for Administrators -->
                {% if "Administrador" in user_groups %}
                    <a href="{% url 'panel_inicio' %}"
                       class="mb-3 block py-2 px-3 rounded hover:bg-blue-100 transition text-blue-600 font-semibold">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 class="w-4 h-4 mr-2"
                                 fill="none"
                                 viewBox="0 0 24 24"
                                 stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Panel de Administración
                        </div>
                    </a>
                {% endif %}
                {% if user_has_clients %}
                    <a href="{% url 'transacciones:configuracion_medios_pago' %}"
                       class="mb-3 block py-2 px-3 rounded hover:bg-neutral-200 transition">Configuración</a>
                    <!-- Client selector for mobile -->
                    <div class="mb-3">
                        <label class="text-sm font-medium block mb-2">Cliente:</label>
                        <select id="clienteSelectorMobile"
                                name="cliente_id"
                                class="select select-bordered w-full text-black rounded-lg border-gray-300 shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            {% for c in request.user.clientes.all %}
                                <option value="{{ c.id }}"
                                        {% if request.cliente and request.cliente.id == c.id %}selected{% endif %}>
                                    {{ c.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                {% endif %}
                <a href="{% url 'seguridad:logout' %}"
                   class="block py-2 px-3 rounded text-red-500 hover:bg-red-100 transition">Cerrar Sesión</a>
            {% endif %}
        </nav>
    </div>
</dialog>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cliente selector para escritorio
    const desktopSelectorElement = document.getElementById("clienteSelector");
    if (desktopSelectorElement) {
        desktopSelectorElement.addEventListener("change", function() {
            const cliente_id = this.value;

            fetch("{% url 'presentacion:cambiar_cliente' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    "cliente_id": cliente_id
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const currentPath = window.location.pathname;
                    const regex = /\/configuracion\/cliente\/\d+\//;
                    if (regex.test(currentPath)) {
                        const newPath = currentPath.replace(/\/configuracion\/cliente\/\d+\//, `/configuracion/cliente/${cliente_id}/`);
                        window.location.href = newPath;
                    } else {
                        window.location.href = currentPath;
                    }
                } else {
                    console.error("Error al cambiar cliente");
                }
            });
        });
    }

    // Cliente selector para móvil
    const mobileSelectorElement = document.getElementById("clienteSelectorMobile");
    if (mobileSelectorElement) {
        mobileSelectorElement.addEventListener("change", function() {
            const cliente_id = this.value;

            fetch("{% url 'presentacion:cambiar_cliente' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    "cliente_id": cliente_id
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const currentPath = window.location.pathname;
                    const regex = /\/configuracion\/cliente\/\d+\//;
                    if (regex.test(currentPath)) {
                        const newPath = currentPath.replace(/\/configuracion\/cliente\/\d+\//, `/configuracion/cliente/${cliente_id}/`);
                        window.location.href = newPath;
                    } else {
                        window.location.href = currentPath;
                    }
                } else {
                    console.error("Error al cambiar cliente");
                }
            });
        });
    }
});
</script>

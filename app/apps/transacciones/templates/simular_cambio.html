{% extends "base.html" %}
{% load static %}
{% block title %}
    Simular Cambio
{% endblock title %}
{% block content %}
<div class="container mx-auto p-8">
    <h2 class="text-3xl font-bold mb-6 text-center">Simulador de Cambio de Divisas</h2>

    <!-- Selección de Cliente -->
    {% if user.is_authenticated %}
        {% if cliente_asociado %}
            <div class="card bg-base-100 shadow-lg mb-6">
                <div class="card-body">
                    <h3 class="card-title">Cliente Asociado</h3>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Cliente</span>
                        </label>
                        <select id="cliente-select" class="select select-bordered" required>
                            <option value="{{ cliente_asociado.id }}" selected>
                                {{ cliente_asociado.nombre }} - {{ cliente_asociado.ruc }}
                            </option>
                        </select>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="alert alert-warning mb-6">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="stroke-current shrink-0 h-6 w-6"
                     fill="none"
                     viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                </svg>
                <span>No tienes clientes asociados. Contacta a un operador para asociar clientes a tu cuenta.</span>
            </div>
        {% endif %}
    {% else %}
        <div class="alert alert-info mb-6">
            <svg xmlns="http://www.w3.org/2000/svg"
                 fill="none"
                 viewBox="0 0 24 24"
                 class="stroke-current shrink-0 w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                </path>
            </svg>
            <span>Para realizar simulaciones personalizadas, inicia sesión con tu cuenta.</span>
        </div>
    {% endif %}

    <!-- Formulario de Simulación -->
    <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
            <form id="simulation-form">
                <div class="grid grid-cols-1 gap-6">
                    <!-- Tipo de Operación -->
                    <div class="form-control col-span-full">
                        <label class="label">
                            <span class="label-text text-lg font-semibold text-primary">¿Qué desea hacer?</span>
                        </label>
                        <div class="flex gap-4 mt-2">
                            <label class="label cursor-pointer">
                                <input type="radio" name="tipo_operacion" value="compra" class="radio radio-primary" checked>
                                <span class="label-text ml-2">Quiero Comprar Divisa</span>
                            </label>
                            <label class="label cursor-pointer">
                                <input type="radio" name="tipo_operacion" value="venta" class="radio radio-primary">
                                <span class="label-text ml-2">Quiero Vender Divisa</span>
                            </label>
                        </div>
                    </div>

                    <!-- Campos en dos columnas -->
                    <div class="grid grid-cols-1 md:grid-cols-3 items-start gap-4">
                        <div class="space-y-6 text-left md:col-span-1 md:w-36">
                            <div class="pt-2">
                                <label class="label"><span class="label-text" id="divisa-label">Quiero</span></label>
                            </div>
                            <div class="pt-2">
                                <label class="label"><span class="label-text" id="monto-label">Monto que Tengo</span></label>
                            </div>
                            <div class="pt-2">
                                <label class="label"><span class="label-text">Método de Pago</span></label>
                            </div>
                            <div class="pt-2">
                                <label class="label"><span class="label-text">Método de Cobro</span></label>
                            </div>
                        </div>
                        <div class="space-y-4 md:col-span-2">
                            <div>
                                <select id="divisa-select" class="select select-bordered w-full text-left ml-0" required>
                                    <option value="">Seleccione una divisa</option>
                                    {% for divisa in divisas %}
                                        <option value="{{ divisa.codigo }}">{{ divisa.codigo }} - {{ divisa.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <input type="number" id="monto-input" name="monto" min="1" step="0.01"
                                       class="input input-bordered w-full text-left ml-0"
                                       placeholder="Ingrese el monto (mínimo 1)" required>
                            </div>
                            <div>
                                <select id="metodo-pago-select" class="select select-bordered w-full text-left ml-0" required>
                                    <option value="efectivo" selected>Efectivo</option>
                                </select>
                            </div>
                            <div>
                                <select id="metodo-cobro-select" class="select select-bordered w-full text-left ml-0" required>
                                    <option value="efectivo" selected>Efectivo</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Resultados de la simulación -->
    <div id="simulation-results" class="card bg-base-100 shadow-lg mt-6 hidden">
        <div class="card-body">
            <h3 class="card-title text-primary">Resultado de la Simulación</h3>
            <div class="flex justify-center">
                <div class="w-full md:w-2/3 lg:w-1/2 text-left space-y-3">
                    <p><strong id="monto-original-label">Monto que Tengo:</strong> <span id="monto-original-val">0</span> <span id="moneda-origen-val">-</span></p>
                    <p><strong>Tasa de Cambio Efectiva:</strong> <span id="tasa-val">-</span></p>
                    <p class="text-2xl font-extrabold text-primary"><strong id="monto-final-label">Monto a Recibir:</strong> <span id="monto-final-val">0</span> <span id="moneda-destino-val">-</span></p>
                </div>
            </div>

            <!-- Desglose de comisión -->
            <div class="collapse collapse-arrow border border-base-300 bg-base-100 rounded-box mt-4">
                <input type="checkbox"/>
                <div class="collapse-title font-medium">Comisión (ver desglose)</div>
                <div class="collapse-content" id="commission-breakdown">
                    <p><strong>Comisión Base:</strong> <span id="comision-base-val">0</span></p>
                    <p><strong>Descuento por Segmento:</strong> <span id="descuento-val">0</span>%</p>
                    <p><strong>Comisión Final:</strong> <span id="comision-final-val">0</span></p>
                    <p id="comision-medio-pago-section" class="hidden"><strong>Comisión Medio de Pago:</strong> <span id="comision-medio-pago-val">0</span> (<span id="comision-medio-pago-pct">0</span>%)</p>
                </div>
            </div>

            <div id="wallet-warning" class="alert alert-warning mt-4 hidden">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                </svg>
                <span>Advertencia: Las billeteras electrónicas pueden cobrar comisiones adicionales por parte del proveedor, no incluidas en esta simulación.</span>
            </div>

            <div class="form-control mt-6">
                {% if user.is_authenticated and cliente_asociado %}
                    <button id="proceed-btn" class="btn btn-success w-full" disabled>Proceder a Realizar Transacción</button>
                {% else %}
                    <button class="btn btn-success w-full" disabled>Proceder a Realizar Transacción</button>
                    <p class="text-sm text-gray-600 mt-2 text-center">Para proceder debe iniciar sesión y tener un cliente asociado.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const clienteSelect = document.getElementById('cliente-select');
    const tipoOperacionInputs = document.querySelectorAll('input[name="tipo_operacion"]');
    const divisaSelect = document.getElementById('divisa-select');
    const montoInput = document.getElementById('monto-input');
    const metodoPagoSelect = document.getElementById('metodo-pago-select');
    const metodoCobroSelect = document.getElementById('metodo-cobro-select');
    const divisaLabel = document.getElementById('divisa-label');
    const montoLabel = document.getElementById('monto-label');
    const resultsCard = document.getElementById('simulation-results');
    const proceedBtn = document.getElementById('proceed-btn');

    let currentCliente = clienteSelect?.value || null;

    function updateLabels() {
        const tipo = [...tipoOperacionInputs].find(i => i.checked)?.value || 'compra';
        divisaLabel.textContent = tipo === 'compra' ? 'Quiero' : 'Tengo';
        montoLabel.textContent = tipo === 'compra' ? 'Monto que Tengo (PYG)' : 'Monto que Tengo';
    }

    // Aquí deberías agregar tus funciones loadDivisas(), loadMediosPago(), performSimulation() como en tu código original,
    // y solo inicializar con currentCliente al cargar la página:
    if (currentCliente) {
        loadMediosPago(currentCliente);
    }

    tipoOperacionInputs.forEach(input => {
        input.addEventListener('change', () => {
            updateLabels();
            if (currentCliente) loadMediosPago(currentCliente);
            performSimulation();
        });
    });

    clienteSelect?.addEventListener('change', () => {
        currentCliente = clienteSelect.value;
        loadMediosPago(currentCliente);
        performSimulation();
    });

    divisaSelect.addEventListener('change', performSimulation);
    montoInput.addEventListener('input', performSimulation);
    metodoPagoSelect.addEventListener('change', performSimulation);
    metodoCobroSelect.addEventListener('change', performSimulation);

    updateLabels();
    loadDivisas();
})();
</script>
{% endblock content %}

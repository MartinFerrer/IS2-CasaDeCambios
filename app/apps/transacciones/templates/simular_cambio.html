{% extends "base.html" %}
{% load static %}
{% block title %}
    Simular Cambio
{% endblock title %}
{% block content %}
    <div class="container mx-auto p-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold">Simulador de Cambio de Divisas</h2>
            <a href="{% url 'presentacion:home' %}" class="btn btn-outline">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="h-5 w-5"
                     fill="none"
                     viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                Volver al inicio
            </a>
        </div>
        <!-- Información del Cliente -->
        {% if user.is_authenticated and request.cliente %}
            <div class="alert alert-info mb-6">
                <svg xmlns="http://www.w3.org/2000/svg"
                     fill="none"
                     viewBox="0 0 24 24"
                     class="stroke-current shrink-0 w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                    </path>
                </svg>
                <span>Simulando para el cliente: <strong>{{ request.cliente.nombre }}</strong> ({{ request.cliente.ruc }})</span>
            </div>
        {% elif user.is_authenticated %}
            <div class="alert alert-warning mb-6">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="stroke-current shrink-0 h-6 w-6"
                     fill="none"
                     viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
                <span>No tienes clientes asociados. Contacta a un operador para asociar clientes a tu cuenta.</span>
            </div>
        {% else %}
            <div class="alert alert-info mb-6">
                <svg xmlns="http://www.w3.org/2000/svg"
                     fill="none"
                     viewBox="0 0 24 24"
                     class="stroke-current shrink-0 w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                    </path>
                </svg>
                <span>Para realizar simulaciones personalizadas, inicia sesión con tu cuenta.</span>
            </div>
        {% endif %}
        <!-- Formulario de Simulación -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <form id="simulation-form">
                    <div class="grid grid-cols-1 gap-6">
                        <!-- Tipo de Operación (full width) -->
                        <div class="form-control col-span-full">
                            <label class="label">
                                <span class="label-text text-lg font-semibold text-primary">¿Qué desea hacer?</span>
                            </label>
                            <div class="flex gap-4 mt-2">
                                <label class="label cursor-pointer">
                                    <input type="radio"
                                           name="tipo_operacion"
                                           value="compra"
                                           class="radio radio-primary"
                                           checked>
                                    <span class="label-text ml-2">Quiero Comprar Divisa</span>
                                </label>
                                <label class="label cursor-pointer">
                                    <input type="radio"
                                           name="tipo_operacion"
                                           value="venta"
                                           class="radio radio-primary">
                                    <span class="label-text ml-2">Quiero Vender Divisa</span>
                                </label>
                            </div>
                        </div>
                        <!-- Fields in two columns: labels (left) and controls (right) -->
                        <div class="grid grid-cols-1 md:grid-cols-3 items-start gap-4">
                            <!-- Label column (narrow) -->
                            <div class="space-y-6 text-left md:col-span-1 md:w-36">
                                <div class="pt-2">
                                    <label class="label">
                                        <span class="label-text" id="divisa-label">Quiero</span>
                                    </label>
                                </div>
                                <div class="pt-2">
                                    <label class="label">
                                        <span class="label-text" id="monto-label">Monto que Tengo</span>
                                    </label>
                                </div>
                                <div class="pt-2">
                                    <label class="label">
                                        <span class="label-text">Método de Pago</span>
                                    </label>
                                </div>
                                <div class="pt-2">
                                    <label class="label">
                                        <span class="label-text">Método de Cobro</span>
                                    </label>
                                </div>
                            </div>
                            <!-- Controls column (wide) -->
                            <div class="space-y-4 md:col-span-2">
                                <div>
                                    <select id="divisa-select"
                                            class="select select-bordered w-full text-left ml-0"
                                            required>
                                        <option value="">Seleccione una divisa</option>
                                        {% for divisa in divisas %}
                                            <option value="{{ divisa.codigo }}">{{ divisa.codigo }} - {{ divisa.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <input type="number"
                                           id="monto-input"
                                           name="monto"
                                           pattern="^\d+$"
                                           min="1"
                                           step="1"
                                           class="input input-bordered w-full text-left ml-0 validator"
                                           placeholder="Ingrese el monto entero (mínimo 1)"
                                           title="El monto debe ser un número entero"
                                           required>
                                    <p id="monto-error"
                                       class="validator-hint text-error text-sm mt-1 hidden">
                                        El monto debe ser un número entero
                                    </p>
                                </div>
                                <div>
                                    <select id="metodo-pago-select"
                                            class="select select-bordered w-full text-left ml-0"
                                            required>
                                        <option value="">Seleccione método de pago</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="metodo-cobro-select"
                                            class="select select-bordered w-full text-left ml-0"
                                            required>
                                        <option value="efectivo" selected>Efectivo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <!-- Resultados de la Simulación -->
            <div id="simulation-results"
                 class="card bg-base-100 shadow-lg mt-6 hidden">
                <div class="card-body">
                    <h3 class="card-title text-primary">Resultado de la Simulación</h3>
                    <div class="flex justify-center">
                        <div class="w-full md:w-2/3 lg:w-1/2 text-left space-y-3">
                            <p>
                                <strong id="monto-original-label">Monto que Deseo:</strong>
                                <span id="monto-original-val">0</span> <span id="moneda-origen-val">-</span>
                            </p>
                            <p>
                                <strong>Tasa Base:</strong> <span id="tasa-base-val">-</span>
                            </p>
                            <!-- Tasa VIP o Corporativa (solo si aplica) -->
                            <p id="tasa-especial-section" class="hidden">
                                <strong id="tasa-especial-label">Tasa VIP:</strong> <span id="tasa-especial-val">-</span>
                            </p>
                            <p class="text-xl font-bold text-secondary">
                                <strong>Cambio Calculado:</strong>
                                <span id="cambio-calculado-val">0</span> <span id="moneda-destino-val">PYG</span>
                            </p>
                            <!-- Comisión Medio de Pago (si aplica - solo para compra) -->
                            <p id="comision-medio-pago-display"
                               class="hidden text-lg font-semibold text-info">
                                <strong>Comisión Medio de Pago:</strong>
                                <span id="comision-medio-pago-display-val">0</span> (<span id="comision-medio-pago-display-pct">0</span>%)
                            </p>
                            <!-- Comisión Medio de Cobro (si aplica - solo para venta) -->
                            <p id="comision-medio-cobro-display"
                               class="hidden text-lg font-semibold text-info">
                                <strong>Comisión Medio de Cobro:</strong>
                                <span id="comision-medio-cobro-display-val">0</span> (<span id="comision-medio-cobro-display-pct">0</span>%)
                            </p>
                            <p class="text-2xl font-extrabold text-primary">
                                <strong id="total-label">Total a Pagar:</strong>
                                <span id="total-val">0</span> <span id="moneda-total-val">PYG</span>
                            </p>
                        </div>
                    </div>
                    <!-- Advertencia para billeteras electrónicas -->
                    <div id="wallet-warning" class="alert alert-warning mt-4 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="stroke-current shrink-0 h-6 w-6"
                             fill="none"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                        </svg>
                        <span>Advertencia: Las billeteras electrónicas pueden cobrar comisiones adicionales por parte del proveedor, no incluidas en esta simulación.</span>
                    </div>
                    <!-- Botón para proceder -->
                    <div class="form-control mt-6">
                        {% if user.is_authenticated %}
                            <button id="proceed-btn" class="btn btn-success w-full" disabled>Proceder a Realizar Transacción</button>
                        {% else %}
                            <button class="btn btn-success w-full" disabled>Proceder a Realizar Transacción</button>
                            <p class="text-sm text-gray-600 mt-2 text-center">Para proceder debe iniciar sesión y tener un cliente asociado.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- Notas Adicionales -->
            <div class="alert alert-info mt-6">
                <svg xmlns="http://www.w3.org/2000/svg"
                     fill="none"
                     viewBox="0 0 24 24"
                     class="stroke-current shrink-0 w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                    </path>
                </svg>
                <span>Las tasas de cambio y comisiones son estimativas y pueden variar. Proceda a realizar una transacción para confirmar.</span>
            </div>
        </div>
        <!-- Módulos JavaScript para transacciones -->
        <script src="{% static 'js/transacciones/formatters.js' %}"></script>
        <script src="{% static 'js/transacciones/validators.js' %}"></script>
        <script src="{% static 'js/transacciones/business-logic.js' %}"></script>
        <script>
        (function() {
            // Importar funciones desde módulos
            const { formatNumber, formatRate, parseInputNumber, formatInputNumber } = window.TransaccionesFormatters;
            const { validateIntegerInput, setupIntegerValidation } = window.TransaccionesValidators;
            const { loadDivisasFromAPI, calculateExchangeAmount } = window.TransaccionesBusinessLogic;
            // Elementos del DOM
            const tipoOperacionInputs = document.querySelectorAll('input[name="tipo_operacion"]');
            const divisaSelect = document.getElementById('divisa-select');
            const montoInput = document.getElementById('monto-input');
            const metodoPagoSelect = document.getElementById('metodo-pago-select');
            const metodoCobroSelect = document.getElementById('metodo-cobro-select');

            // Labels dinámicos
            const divisaLabel = document.getElementById('divisa-label');
            const montoLabel = document.getElementById('monto-label');

            // Elementos de resultados
            const resultsCard = document.getElementById('simulation-results');
            const montoOriginalLabel = document.getElementById('monto-original-label');
            const montoOriginalVal = document.getElementById('monto-original-val');
            const monedaOrigenVal = document.getElementById('moneda-origen-val');
            const tasaBaseVal = document.getElementById('tasa-base-val');
            const tasaEspecialSection = document.getElementById('tasa-especial-section');
            const tasaEspecialLabel = document.getElementById('tasa-especial-label');
            const tasaEspecialVal = document.getElementById('tasa-especial-val');
            const cambioCalculadoVal = document.getElementById('cambio-calculado-val');
            const monedaDestinoVal = document.getElementById('moneda-destino-val');
            const comisionMedioPagoDisplay = document.getElementById('comision-medio-pago-display');
            const comisionMedioPagoDisplayVal = document.getElementById('comision-medio-pago-display-val');
            const comisionMedioPagoDisplayPct = document.getElementById('comision-medio-pago-display-pct');
            const comisionMedioCobroDisplay = document.getElementById('comision-medio-cobro-display');
            const comisionMedioCobroDisplayVal = document.getElementById('comision-medio-cobro-display-val');
            const comisionMedioCobroDisplayPct = document.getElementById('comision-medio-cobro-display-pct');
            const totalLabel = document.getElementById('total-label');
            const totalVal = document.getElementById('total-val');
            const monedaTotalVal = document.getElementById('moneda-total-val');
            const walletWarning = document.getElementById('wallet-warning');
            const proceedBtn = document.getElementById('proceed-btn');

            // Estado global
            const currentCliente = {% if request.cliente %}{{ request.cliente.id }}{% else %}null{% endif %};
            let availableDivisas = [];

            // Función local para obtener tipo de operación desde radio buttons
            function getTipoOperacion() {
                const radioChecked = document.querySelector('input[name="tipo_operacion"]:checked');
                return radioChecked ? radioChecked.value : 'compra';
            }

            // Configuración específica para formateo
            const isoDecimals = { PYG: 0, USD: 2, EUR: 2, BRL: 2 };

            // Función adaptada para usar el módulo de formatters con configuración específica
            function formatNumberWithCurrency(value, currency) {
                return formatNumber(value, isoDecimals[currency] || 2);
            }

            // Función adaptada para labels usando lógica del módulo business-logic
            function updateLabelsLocal() {
                const tipo = getTipoOperacion();
                const labelMap = {
                    compra: {
                        divisa: 'Quiero',
                        monto: 'Monto que Deseo',
                        montoOriginal: 'Monto que Deseo:',
                        total: 'Total a Pagar:'
                    },
                    venta: {
                        divisa: 'Tengo',
                        monto: 'Monto que Tengo',
                        montoOriginal: 'Monto que Tengo:',
                        total: 'Total a Recibir:'
                    }
                };

                const labels = labelMap[tipo];
                divisaLabel.textContent = labels.divisa;
                montoLabel.textContent = labels.monto;
                montoOriginalLabel.textContent = labels.montoOriginal;
                totalLabel.textContent = labels.total;
            }

            // Objeto para almacenar divisas disponibles
            const divisasStorage = { divisas: [] };

            // Función local que usa el módulo loadDivisasFromAPI
            async function loadDivisasLocal() {
                const success = await loadDivisasFromAPI(
                    divisaSelect,
                    '{% url "transacciones:api_divisas_disponibles" %}',
                    divisasStorage
                );

                // Actualizar referencia para compatibilidad
                if (success) {
                    availableDivisas = divisasStorage.divisas;
                }
            }

            // Cargar medios de pago del cliente
            async function loadMediosPago() {
                if (!currentCliente) {
                    resetMediosPago();
                    return;
                }

                try {
                    const tipo = getTipoOperacion();
                    const response = await fetch(`{% url "transacciones:api_medios_pago_cliente" cliente_id=0 %}`.replace('0', currentCliente) + `?tipo=${tipo}`);
                    const data = await response.json();

                    // Limpiar y rellenar método de pago
                    metodoPagoSelect.innerHTML = '';

                    // Agregar opción vacía si hay múltiples métodos digitales
                    const metodosDigitales = data.medios_pago.filter(medio => medio.id !== 'efectivo');
                    if (metodosDigitales.length > 1) {
                        const emptyOption = document.createElement('option');
                        emptyOption.value = '';
                        emptyOption.textContent = 'Seleccione método de pago';
                        metodoPagoSelect.appendChild(emptyOption);
                    }

                    let hasEfectivoPago = false;
                    data.medios_pago.forEach((medio, index) => {
                        const optionPago = document.createElement('option');
                        optionPago.value = medio.id;
                        optionPago.textContent = `${medio.nombre} (${medio.comision}%)`;
                        optionPago.dataset.comision = medio.comision;

                        // Solo autoseleccionar si hay efectivo O si hay solo un método digital
                        if (medio.id === 'efectivo') {
                            hasEfectivoPago = true;
                            optionPago.selected = true;
                        } else if (metodosDigitales.length === 1 && index === 0 && !hasEfectivoPago) {
                            // Solo autoseleccionar si hay un único método digital disponible
                            optionPago.selected = true;
                        }
                        metodoPagoSelect.appendChild(optionPago);
                    });

                    // Limpiar y rellenar método de cobro
                    metodoCobroSelect.innerHTML = '';

                    // Agregar opción vacía si hay múltiples métodos digitales
                    const metodosCobroDigitales = data.medios_cobro.filter(medio => medio.id !== 'efectivo');
                    if (metodosCobroDigitales.length > 1) {
                        const emptyOption = document.createElement('option');
                        emptyOption.value = '';
                        emptyOption.textContent = 'Seleccione método de cobro';
                        metodoCobroSelect.appendChild(emptyOption);
                    }

                    data.medios_cobro.forEach((medio, index) => {
                        const optionCobro = document.createElement('option');
                        optionCobro.value = medio.id;
                        optionCobro.textContent = `${medio.nombre} (${medio.comision}%)`;
                        optionCobro.dataset.comision = medio.comision;

                        // Solo autoseleccionar si hay efectivo O si hay solo un método digital
                        if (medio.id === 'efectivo') {
                            optionCobro.selected = true;
                        } else if (metodosCobroDigitales.length === 1 && index === 0) {
                            // Solo autoseleccionar si hay un único método digital disponible
                            optionCobro.selected = true;
                        }
                        metodoCobroSelect.appendChild(optionCobro);
                    });

                } catch (error) {
                    console.error('Error loading medios de pago:', error);
                    resetMediosPago();
                }
            }

            function resetMediosPago() {
                const tipo = getTipoOperacion();
                if (tipo === 'compra') {
                    // Para compra, no mostrar efectivo por defecto
                    metodoPagoSelect.innerHTML = '<option value="">Seleccione método de pago</option>';
                } else {
                    // Para venta, sí mostrar efectivo
                    metodoPagoSelect.innerHTML = '<option value="efectivo" selected>Efectivo</option>';
                }
                metodoCobroSelect.innerHTML = '<option value="efectivo" selected>Efectivo</option>';
            }

            // Realizar simulación
            async function performSimulation() {
                const monto = parseInputNumber(montoInput.value);
                const divisa = divisaSelect.value;
                const tipo = getTipoOperacion();

                // Validar que el monto sea un número entero
                if (montoInput.value && !Number.isInteger(parseFloat(montoInput.value))) {
                    resultsCard.classList.add('hidden');
                    return;
                }

                if (monto < 1 || !divisa) {
                    resultsCard.classList.add('hidden');
                    return;
                }

                const params = new URLSearchParams({
                    monto: monto.toString(),
                    divisa_seleccionada: divisa,
                    tipo_operacion: tipo,
                    metodo_pago: metodoPagoSelect.value,
                    metodo_cobro: metodoCobroSelect.value
                });

                try {
                    const response = await fetch(`{% url "transacciones:api_simular_cambio" %}?${params.toString()}`);
                    const data = await response.json();

                    // Actualizar resultados con nueva estructura
                    const tipo = getTipoOperacion();

                    // Monto original
                    montoOriginalVal.textContent = formatNumberWithCurrency(data.monto_original, data.moneda_origen);
                    monedaOrigenVal.textContent = data.moneda_origen;

                    // Tasa base
                    tasaBaseVal.textContent = `1 ${data.moneda_origen} = ${formatRate(data.tasa_base)} PYG`;

                    // Tasa especial (VIP o Corporativa) - solo mostrar si hay descuento
                    if (data.tipo_cliente && data.descuento > 0) {
                        tasaEspecialSection.classList.remove('hidden');

                        // Determinar el label según el tipo de cliente
                        if (data.tipo_cliente.toUpperCase().includes('VIP')) {
                            tasaEspecialLabel.textContent = 'Tasa VIP:';
                        } else if (data.tipo_cliente.toUpperCase().includes('CORPORAT')) {
                            tasaEspecialLabel.textContent = 'Tasa Corporativa:';
                        } else {
                            tasaEspecialLabel.textContent = 'Tasa Especial:';
                        }

                        tasaEspecialVal.textContent = `1 ${data.moneda_origen} = ${formatRate(data.tasa_cambio)} PYG`;
                    } else {
                        tasaEspecialSection.classList.add('hidden');
                    }

                    // Cambio calculado (monto convertido sin comisión de medio de pago)
                    cambioCalculadoVal.textContent = formatNumberWithCurrency(data.total_antes_comision_medio, "PYG");
                    monedaDestinoVal.textContent = "PYG";

                    // Comisión medio de pago (solo mostrar si > 0 y tipo compra)
                    if (tipo === 'compra' && data.comision_medio_pago_monto > 0) {
                        comisionMedioPagoDisplay.classList.remove('hidden');
                        comisionMedioPagoDisplayVal.textContent = formatNumberWithCurrency(data.comision_medio_pago_monto, "PYG");
                        comisionMedioPagoDisplayPct.textContent = data.comision_medio_pago_porcentaje;
                        comisionMedioCobroDisplay.classList.add('hidden');
                    } else if (tipo === 'venta' && data.comision_medio_cobro_monto > 0) {
                        // Comisión medio de cobro (solo mostrar si > 0 y tipo venta)
                        comisionMedioCobroDisplay.classList.remove('hidden');
                        comisionMedioCobroDisplayVal.textContent = formatNumberWithCurrency(data.comision_medio_cobro_monto, "PYG");
                        comisionMedioCobroDisplayPct.textContent = data.comision_medio_cobro_porcentaje;
                        comisionMedioPagoDisplay.classList.add('hidden');
                    } else {
                        comisionMedioPagoDisplay.classList.add('hidden');
                        comisionMedioCobroDisplay.classList.add('hidden');
                    }

                    // Total a pagar
                    totalVal.textContent = formatNumberWithCurrency(data.total, "PYG");
                    monedaTotalVal.textContent = "PYG";

                    // Actualizar label del total según el tipo de operación
                    if (tipo === 'compra') {
                        totalLabel.textContent = 'Total a Pagar:';
                    } else {
                        totalLabel.textContent = 'Total a Recibir:';
                    }

                    // Mostrar advertencia de billeteras
                    const metodoPago = metodoPagoSelect.value;
                    const metodoCobro = metodoCobroSelect.value;
                    if (metodoPago.includes('billetera') || metodoCobro.includes('billetera')) {
                        walletWarning.classList.remove('hidden');
                    } else {
                        walletWarning.classList.add('hidden');
                    }

                    // Habilitar botón proceder si hay cliente seleccionado
                    if (proceedBtn) {
                        proceedBtn.disabled = !currentCliente;
                    }

                    resultsCard.classList.remove('hidden');

                } catch (error) {
                    console.error('Error performing simulation:', error);
                    resultsCard.classList.add('hidden');
                }
            }

            // Event listeners
            tipoOperacionInputs.forEach(input => {
                input.addEventListener('change', function() {
                    updateLabelsLocal();
                    // Recargar medios de pago porque las opciones de cobro cambian según el tipo
                    if (currentCliente) {
                        loadMediosPago();
                    }
                    performSimulation();
                });
            });

            divisaSelect.addEventListener('change', performSimulation);

            // Event listeners para formateo en tiempo real del input de monto
            montoInput.addEventListener('input', function(e) {
                const value = e.target.value;
                const montoError = document.getElementById('monto-error');

                // Validar si es un número entero
                if (value && !/^[0-9]+$/.test(value)) {
                    // Mostrar error y cambiar estilo del input
                    montoError.classList.remove('hidden');
                    e.target.classList.remove('input-bordered');
                    e.target.classList.add('input-error');

                    // No borrar el valor, mantenerlo para que el usuario pueda corregirlo
                    return;
                } else {

                    // Ocultar error y restaurar estilo normal
                    montoError.classList.add('hidden');
                    e.target.classList.remove('input-error');
                    e.target.classList.add('input-bordered');
                }

                performSimulation();
            });

            // Prevenir caracteres no válidos
            montoInput.addEventListener('keypress', function(e) {
                const char = String.fromCharCode(e.which);
                if (!/[\d, ]/.test(char) && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                }
            });

            metodoPagoSelect.addEventListener('change', performSimulation);
            metodoCobroSelect.addEventListener('change', performSimulation);

            // Manejar click del botón "Proceder a Realizar Transacción"
            if (proceedBtn) {
                proceedBtn.addEventListener('click', function() {
                    if (!currentCliente) {
                        alert('Debe tener un cliente asociado para proceder.');
                        return;
                    }

                    // Obtener los valores actuales del formulario
                    const tipoOperacion = getTipoOperacion();
                    const divisaOrigen = tipoOperacion === 'compra' ? 'USD' : divisaSelect.value;
                    const divisaDestino = tipoOperacion === 'compra' ? divisaSelect.value : 'USD';
                    const monto = parseInputNumber(montoInput.value);
                    const metodoPago = metodoPagoSelect.value;
                    const metodoCobro = metodoCobroSelect.value;

                    // Construir URL con parámetros de la simulación
                    const params = new URLSearchParams({
                        tipo_operacion: tipoOperacion,
                        divisa_origen: divisaOrigen,
                        divisa_destino: divisaDestino,
                        monto: monto,
                        metodo_pago: metodoPago,
                        metodo_cobro: metodoCobro
                    });

                    // Redirigir a la página de realizar transacción con los parámetros
                    window.location.href = `{% url 'transacciones:realizar_transaccion' %}?${params.toString()}`;
                });
            }

            // Inicialización
            updateLabelsLocal();
            loadDivisasLocal();
            if (currentCliente) {
                loadMediosPago();
            }
        })();
        </script>
    </div>
{% endblock content %}

{% load custom_filters %}
{% load l10n %}
<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Banco Simulado - Gateway de Pagos</title>
        <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css"
              rel="stylesheet"
              type="text/css" />
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .bank-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 0 auto;
            overflow: hidden;
        }
        .bank-header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .bank-logo {
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .status-card {
            padding: 30px;
            text-align: center;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        .action-buttons {
            padding: 20px 30px;
            background: #f8fafc;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-ghost { background: #e5e7eb; color: #374151; }
        .btn-ghost:hover { background: #d1d5db; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .hidden { display: none !important; }
        </style>
    </head>
    <body>
        <div class="bank-container">
            <!-- Header del banco -->
            <div class="bank-header">
                <div class="bank-logo">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-10 w-10"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.78 0-2.678-2.153-1.415-3.414l5-5A2 2 0 009 9.172V5L8 4z" />
                    </svg>
                </div>
                <h1 class="text-2xl font-bold mb-2">Banco Central Simulado</h1>
                <p class="opacity-90">Gateway de Procesamiento de Pagos</p>
            </div>
            <!-- Información de la transacción -->
            <div class="p-6">
                {% if error %}
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                        <h3 class="font-semibold text-red-800 mb-3">Error</h3>
                        <p class="text-red-600">{{ error }}</p>
                    </div>
                {% elif transaccion %}
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h3 class="font-semibold text-gray-800 mb-3">Detalles de la Transacción</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="font-medium">ID:</span> <span class="font-mono">{{ transaccion.id_transaccion }}</span>
                            </div>
                            <div>
                                <span class="font-medium">Cliente:</span> {{ transaccion.cliente.nombre }}
                            </div>
                            <div>
                                <span class="font-medium">Tipo:</span> {{ transaccion.tipo_operacion|capfirst }}
                            </div>
                            <div>
                                <span class="font-medium">Monto:</span> {{ transaccion.monto_destino|strip_trailing_zeros }} {{ transaccion.divisa_destino.codigo }}
                            </div>
                        </div>
                    </div>
                {% endif %}
                <!-- Estados del procesamiento -->
                {% if not error %}
                    <div class="status-card">
                        <!-- Estado: Conectando -->
                        <div id="estadoConectando">
                            <div class="spinner"></div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Estableciendo conexión segura</h3>
                            <p class="text-gray-600">Verificando credenciales y datos de la transacción...</p>
                        </div>
                        <!-- Estado: Procesando -->
                        <div id="estadoProcesando" class="hidden">
                            <div class="spinner"></div>
                            <h3 class="text-lg font-semibold text-blue-800 mb-2">Procesando pago</h3>
                            <p class="text-blue-600 mb-4">El banco está validando y autorizando la transacción</p>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                     id="progressBar"
                                     style="width: 0%"></div>
                            </div>
                            <div class="text-sm text-gray-600 mt-2" id="progressText">0%</div>
                        </div>
                        <!-- Estado: Éxito -->
                        <div id="estadoExitoso" class="hidden">
                            <div class="result-icon">✓</div>
                            <h3 class="text-lg font-semibold text-green-800 mb-2">Pago Aprobado</h3>
                            <p class="text-green-600 mb-4">La transacción ha sido procesada exitosamente</p>
                            <div class="text-sm text-gray-600 mt-4">
                                <div class="loading loading-dots loading-sm"></div>
                                Redirigiendo automáticamente...
                            </div>
                        </div>
                        <!-- Estado: Error -->
                        <div id="estadoError" class="hidden">
                            <div class="result-icon">✗</div>
                            <h3 class="text-lg font-semibold text-red-800 mb-2">Pago Rechazado</h3>
                            <p class="text-red-600 mb-4" id="mensajeError">Error en el procesamiento de la transacción</p>
                            <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                                <div class="text-xs text-gray-600">Código de error</div>
                                <div class="font-mono text-sm font-bold text-gray-800" id="codigoError">-</div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <!-- Estado de error del servidor -->
                    <div class="status-card">
                        <div class="result-icon">✗</div>
                        <h3 class="text-lg font-semibold text-red-800 mb-2">Error del Sistema</h3>
                        <p class="text-red-600 mb-4">{{ error }}</p>
                    </div>
                {% endif %}
            </div>
            <!-- Botones de acción -->
            <div class="action-buttons">
                <button id="btnCerrar"
                        class="btn btn-ghost"
                        onclick="cerrarVentana()"
                        disabled>Cerrar</button>
                <button id="btnReintentar"
                        class="btn btn-warning hidden"
                        onclick="reintentarPago()">Reintentar</button>
            </div>
        </div>
        <!-- Token CSRF -->
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        <script>
        {% if not error and transaccion %}
        const transaccionId = '{{ transaccion.id_transaccion }}';
        let procesoCompletado = false;

        // Iniciar el proceso automáticamente
        window.addEventListener('load', function() {
            setTimeout(iniciarProcesamiento, 2000);
        });
        {% else %}
        const transaccionId = '';
        let procesoCompletado = true; // Para que no se procese nada
        {% endif %}

        function iniciarProcesamiento() {
            try {
                // Cambiar a estado procesando
                document.getElementById('estadoConectando').classList.add('hidden');
                document.getElementById('estadoProcesando').classList.remove('hidden');

                // Iniciar progreso visual mientras consultamos al banco externo
                let progreso = 0;
                const interval = setInterval(() => {
                    progreso += Math.random() * 8; 
                    if (progreso > 90) progreso = 90; // No llegar al 100% hasta que tengamos respuesta
                    
                    document.getElementById('progressBar').style.width = progreso + '%';
                    document.getElementById('progressText').textContent = Math.round(progreso) + '%';
                }, 600);

                // Llamar al servicio bancario externo
                consultarBancoExterno(interval);
            } catch (error) {
                console.error('Error en iniciarProcesamiento:', error);
            }
        }

        function consultarBancoExterno(progressInterval) {
            try {
                // Detectar URL del servicio bancario externo
                let bancoUrl;
                const hostname = window.location.hostname;
                const port = window.location.port;
                const protocol = window.location.protocol;
                
                if (hostname === 'localhost' && port === '8000') {
                    // Desarrollo local (Django dev server)
                    bancoUrl = 'http://localhost:5002/api/procesar-transaccion';
                } else if (hostname === 'localhost' && port === '8080') {
                    // Producción local (puerto 8080)
                    bancoUrl = 'http://localhost:5001/api/procesar-transaccion';
                } else if (hostname.includes('herokuapp.com')) {
                    // Deploy en Heroku - usar app separada del simulador
                    bancoUrl = 'https://global-exchange-simulador-ec091cfa7acb.herokuapp.com/api/procesar-transaccion';
                } else {
                    // Docker u otros entornos
                    bancoUrl = `http://${hostname}:5001/api/procesar-transaccion`;
                }
            
            // Preparar datos de la transacción para el banco externo
            const datosTransaccion = {
                transaccion_id: transaccionId,
                monto: parseFloat('{{ transaccion.monto_destino|default:0|unlocalize }}'),
                divisa: '{{ transaccion.divisa_destino.codigo|default:"PYG" }}',
                medio_pago: '{{ transaccion.medio_pago|default:"efectivo" }}',
                medio_cobro: '{{ transaccion.medio_cobro|default:"efectivo" }}',
                numero_cuenta: obtenerNumeroCuenta(),
                datos_adicionales: {
                    cliente_id: '{{ transaccion.cliente.id|default:"" }}',
                    cliente_nombre: '{{ transaccion.cliente.nombre|default:"" }}',
                    tipo_operacion: '{{ transaccion.tipo_operacion|default:"compra" }}',
                    monto_origen: parseFloat('{{ transaccion.monto_origen|default:0|unlocalize }}'),
                    divisa_origen: '{{ transaccion.divisa_origen.codigo|default:"PYG" }}',
                    tasa_aplicada: parseFloat('{{ transaccion.tasa_aplicada|default:0|unlocalize }}'),
                    fecha_transaccion: '{{ transaccion.fecha_creacion|date:"c"|default:"" }}',
                    estado_transaccion: '{{ transaccion.estado|default:"pendiente" }}'
                }
            };

            console.log('Datos a enviar:', datosTransaccion);
            console.log('Realizando fetch a:', bancoUrl);

            fetch(bancoUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datosTransaccion)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error del banco: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Detener progreso visual
                clearInterval(progressInterval);
                
                // Completar barra de progreso
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressText').textContent = '100%';
                
                // Procesar respuesta del banco externo
                setTimeout(() => {
                    procesarRespuestaBanco(data);
                }, 1000);
            })
            .catch(error => {
                console.error('Error conectando con banco externo:', error);
                
                // Detener progreso visual
                clearInterval(progressInterval);
                
                // Mostrar error de conexión
                mostrarErrorConexion(error.message);
            });
            } catch (error) {
                console.error('Error en consultarBancoExterno:', error);
                
                // Detener progreso visual
                clearInterval(progressInterval);
                
                // Mostrar error de conexión
                mostrarErrorConexion('Error en consultarBancoExterno: ' + error.message);
            }
        }

        function obtenerNumeroCuenta() {
            // Obtener los objetos de medios de pago reales
            const medioPago = '{{ transaccion.medio_pago|default:"efectivo" }}';
            const medioCobro = '{{ transaccion.medio_cobro|default:"efectivo" }}';
            
            console.log(`Medios de pago detectados: Pago=${medioPago}, Cobro=${medioCobro}`);
            
            // Priorizar el medio de pago sobre el medio de cobro para obtener el número
            let numeroIdentificador = '';
            
            // Si hay medio de pago (no efectivo), usar ese
            if (medioPago && medioPago !== 'efectivo') {
                {% if medio_pago_obj %}
                    {% if medio_pago_obj.numero_tarjeta %}
                        // Es una tarjeta de crédito
                        numeroIdentificador = '{{ medio_pago_obj.numero_tarjeta }}';
                        console.log('Usando número de tarjeta de pago:', numeroIdentificador);
                    {% elif medio_pago_obj.numero_cuenta %}
                        // Es una cuenta bancaria
                        numeroIdentificador = '{{ medio_pago_obj.numero_cuenta }}';
                        console.log('Usando número de cuenta de pago:', numeroIdentificador);
                    {% elif medio_pago_obj.identificador %}
                        // Es una billetera electrónica
                        numeroIdentificador = '{{ medio_pago_obj.identificador }}';
                        console.log('Usando identificador de billetera de pago:', numeroIdentificador);
                    {% endif %}
                {% endif %}
            }
            
            // Si no se obtuvo del medio de pago, intentar con medio de cobro
            if (!numeroIdentificador && medioCobro && medioCobro !== 'efectivo') {
                {% if medio_cobro_obj %}
                    {% if medio_cobro_obj.numero_tarjeta %}
                        // Es una tarjeta de crédito
                        numeroIdentificador = '{{ medio_cobro_obj.numero_tarjeta }}';
                        console.log('Usando número de tarjeta de cobro:', numeroIdentificador);
                    {% elif medio_cobro_obj.numero_cuenta %}
                        // Es una cuenta bancaria
                        numeroIdentificador = '{{ medio_cobro_obj.numero_cuenta }}';
                        console.log('Usando número de cuenta de cobro:', numeroIdentificador);
                    {% elif medio_cobro_obj.identificador %}
                        // Es una billetera electrónica
                        numeroIdentificador = '{{ medio_cobro_obj.identificador }}';
                        console.log('Usando identificador de billetera de cobro:', numeroIdentificador);
                    {% endif %}
                {% endif %}
            }
            
            // Si aún no se encontró un número, usar valores por defecto para QA
            if (!numeroIdentificador) {
                console.log('No se encontró medio financiero específico, usando valores de prueba para QA');
                
                if (medioPago.includes('tarjeta') || medioCobro.includes('tarjeta')) {
                    // Valores de prueba para tarjetas
                    numeroIdentificador = '4000000000000077'; // Visa exitosa para QA
                    console.log('Usando tarjeta de prueba QA:', numeroIdentificador);
                } else if (medioPago.includes('cuenta') || medioCobro.includes('cuenta')) {
                    // Valor de prueba para cuentas
                    numeroIdentificador = '0001234567890';
                    console.log('Usando cuenta de prueba QA:', numeroIdentificador);
                } else if (medioPago.includes('billetera') || medioCobro.includes('billetera')) {
                    // Valor de prueba para billeteras
                    numeroIdentificador = '+595981234567';
                    console.log('Usando billetera de prueba QA:', numeroIdentificador);
                }
            }
            
            console.log('Número final a enviar al banco:', numeroIdentificador);
            return numeroIdentificador;
        }

        function procesarRespuestaBanco(respuesta) {
            if (respuesta.exito) {
                mostrarExito();
            } else {
                mostrarError(respuesta.codigo_error, respuesta.mensaje_error);
            }
        }

        function mostrarExito() {
            // Ocultar procesando
            document.getElementById('estadoProcesando').classList.add('hidden');
            document.getElementById('estadoExitoso').classList.remove('hidden');
            
            procesoCompletado = true;
            
            // Procesar en el backend
            procesarPagoBackend(true, null);
            
            // Mostrar mensaje de éxito por 2 segundos y luego abrir popup TAUSER
            setTimeout(() => {
                // Cerrar este popup
                window.close();
                
                // Abrir popup para código TAUSER de retiro
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'abrirTauserRetiro',
                        transaccionId: transaccionId
                    }, '*');
                }
            }, 2000);
        }

        function mostrarError(codigoError, mensajeError) {
            // Ocultar procesando
            document.getElementById('estadoProcesando').classList.add('hidden');
            document.getElementById('estadoError').classList.remove('hidden');
            
            // Usar datos del banco externo
            document.getElementById('codigoError').textContent = codigoError || 'ERR-UNKNOWN';
            document.getElementById('mensajeError').textContent = mensajeError || 'Error desconocido del banco';
            
            // Habilitar botones
            document.getElementById('btnReintentar').classList.remove('hidden');
            document.getElementById('btnCerrar').disabled = false;
            
            // Procesar en el backend
            procesarPagoBackend(false, `${codigoError}: ${mensajeError}`);
        }

        function mostrarErrorConexion(mensajeError) {
            // Ocultar procesando
            document.getElementById('estadoProcesando').classList.add('hidden');
            document.getElementById('estadoError').classList.remove('hidden');
            
            // Mostrar error de conexión específico
            document.getElementById('codigoError').textContent = 'ERR-CONEXION';
            document.getElementById('mensajeError').textContent = `Error de conexión con el banco: ${mensajeError}`;
            
            // Habilitar botones
            document.getElementById('btnReintentar').classList.remove('hidden');
            document.getElementById('btnCerrar').disabled = false;
            
            // Procesar en el backend
            procesarPagoBackend(false, `ERR-CONEXION: ${mensajeError}`);
        }

        function procesarPagoBackend(exito, mensajeError) {
            fetch('/transacciones/api/procesar-pago-bancario/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    transaccion_id: transaccionId,
                    exito: exito,
                    mensaje_error: mensajeError
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('Error al procesar resultado del pago:', data.message);
                }
            })
            .catch(error => {
                console.error('Error de conexión:', error);
            });
        }

        function reintentarPago() {
            // Resetear a estado inicial
            document.getElementById('estadoError').classList.add('hidden');
            document.getElementById('estadoConectando').classList.remove('hidden');
            
            // Ocultar botones
            document.getElementById('btnReintentar').classList.add('hidden');
            document.getElementById('btnCerrar').disabled = true;
            
            setTimeout(iniciarProcesamiento, 1500);
        }

        function continuarYCerrar() {
            if (procesoCompletado) {
                // Notificar a la ventana padre y cerrar
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'pagoCompletado',
                        transaccionId: transaccionId,
                        exito: true
                    }, '*');
                }
                window.close();
            }
        }

        function cerrarVentana() {
            // Notificar a la ventana padre si es necesario
            if (window.opener && procesoCompletado) {
                window.opener.postMessage({
                    type: 'ventanaCerrada',
                    transaccionId: transaccionId
                }, '*');
            }
            window.close();
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            // Si no encuentra la cookie, usar el token del input hidden
            if (!cookieValue) {
                const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
                if (csrfInput) {
                    cookieValue = csrfInput.value;
                }
            }
            return cookieValue;
        }

        // Manejar cierre de ventana
        window.addEventListener('beforeunload', function() {
            if (window.opener && !procesoCompletado) {
                window.opener.postMessage({
                    type: 'ventanaCerradaSinCompletar',
                    transaccionId: transaccionId
                }, '*');
            }
        });
        </script>
    </body>
</html>

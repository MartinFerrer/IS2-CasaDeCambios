{% extends "base.html" %}
{% load static %}
{% block title %}
    Transacci√≥n Procesada
{% endblock title %}
{% block content %}
    <div class="container mx-auto p-8">
        <div class="flex items-center justify-center mb-8">
            <div class="text-center">
                <div class="text-6xl mb-4">‚úÖ</div>
                <h2 class="text-3xl font-bold text-success">¬°Transacci√≥n Creada Exitosamente!</h2>
                <p class="text-gray-600 mt-2">Tu transacci√≥n ha sido registrada y est√° lista para procesar</p>
            </div>
        </div>
        <!-- Informaci√≥n de la transacci√≥n -->
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-body">
                <h3 class="card-title text-primary mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-6 w-6"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V17a2 2 0 01-2 2z" />
                    </svg>
                    Detalles de la Transacci√≥n
                </h3>
                <!-- ID de transacci√≥n destacado -->
                <div class="bg-gradient-to-r from-success/20 to-success/10 border border-success/30 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="text-sm font-medium text-success mb-2">üî¢ C√≥digo de Transacci√≥n</div>
                            <div class="font-mono text-lg font-bold bg-white/60 px-4 py-2 rounded border-2 border-dashed border-success/40 text-gray-800">
                                {{ transaccion.id_transaccion }}
                            </div>
                        </div>
                        <div class="flex-none ml-4">
                            <button class="btn btn-lg btn-success btn-outline"
                                    onclick="copyToClipboard('{{ transaccion.id_transaccion }}')">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     class="h-4 w-4"
                                     fill="none"
                                     viewBox="0 0 24 24"
                                     stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                                Copiar
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Resumen de la transacci√≥n -->
                <div class="bg-base-200 p-6 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-3">
                            <div>
                                <span class="font-semibold">Cliente:</span>
                                <span class="ml-2">{{ transaccion.cliente.nombre }}</span>
                            </div>
                            <div>
                                <span class="font-semibold">Tipo de Operaci√≥n:</span>
                                <span class="ml-2 capitalize">
                                    {% if transaccion.tipo_operacion == 'compra' %}
                                        Compra de divisa
                                    {% else %}
                                        Venta de divisa
                                    {% endif %}
                                </span>
                            </div>
                            <div>
                                <span class="font-semibold">Estado:</span>
                                <span class="badge badge-warning ml-2">Pendiente</span>
                            </div>
                            <div>
                                <span class="font-semibold">Fecha de Creaci√≥n:</span>
                                <span class="ml-2">{{ transaccion.fecha_creacion|date:"d/m/Y H:i" }}</span>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <span class="font-semibold">Divisa Origen:</span>
                                <span class="ml-2">{{ transaccion.divisa_origen.codigo }}</span>
                            </div>
                            <div>
                                <span class="font-semibold">Divisa Destino:</span>
                                <span class="ml-2">{{ transaccion.divisa_destino.codigo }}</span>
                            </div>
                            <div>
                                <span class="font-semibold">Tasa Aplicada:</span>
                                <span class="ml-2">{{ transaccion.tasa_aplicada|floatformat:8 }}</span>
                            </div>
                            <div>
                                <span class="font-semibold">Monto:</span>
                                <span class="ml-2">{{ transaccion.monto_origen|floatformat:2 }} {{ transaccion.divisa_origen.codigo }}</span>
                            </div>
                        </div>
                    </div>
                    <!-- Total destacado -->
                    <div class="divider"></div>
                    <div class="bg-gradient-to-br from-primary/5 via-secondary/5 to-accent/5 border-2 border-primary/20 rounded-xl p-6">
                        <div class="text-center">
                            <div class="text-2xl font-semibold text-primary mb-3 uppercase tracking-wide">
                                {% if transaccion.tipo_operacion == 'compra' %}
                                    Total a Pagar
                                {% else %}
                                    Total a Recibir
                                {% endif %}
                            </div>
                            <div class="text-3xl font-bold text-primary mb-3 drop-shadow-sm">
                                {{ transaccion.monto_destino|floatformat:0 }} {{ transaccion.divisa_destino.codigo }}
                            </div>
                            <div class="bg-white/70 rounded-lg px-4 py-2 inline-block">
                                <div class="text-xs text-gray-600">Tasa de cambio aplicada</div>
                                <div class="text-sm font-bold text-gray-800">{{ transaccion.tasa_aplicada|floatformat:4 }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Medios de pago/cobro -->
        <div class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <h3 class="card-title text-primary mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-6 w-6"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                    </svg>
                    Medios de Procesamiento
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <div class="font-semibold mb-2">Medio de Pago:</div>
                        <div class="p-3 bg-base-200 rounded-lg">{{ nombre_metodo_pago|default:"Efectivo" }}</div>
                    </div>
                    <div>
                        <div class="font-semibold mb-2">Medio de Cobro:</div>
                        <div class="p-3 bg-base-200 rounded-lg">{{ nombre_metodo_cobro|default:"Efectivo" }}</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Alerta sobre comisiones externas -->
        <div class="alert alert-warning mb-6">
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="stroke-current shrink-0 h-6 w-6"
                 fill="none"
                 viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
            </svg>
            <div>
                <div class="font-bold">Informaci√≥n Importante sobre Comisiones</div>
                <div class="text-sm">
                    El monto final a pagar o recibir puede variar debido a comisiones externas aplicadas por el proveedor del medio de pago seleccionado.
                    Las billeteras electr√≥nicas, tarjetas de cr√©dito y transferencias bancarias pueden generar costos adicionales que no est√°n incluidos en el c√°lculo mostrado.
                </div>
            </div>
        </div>
        <!-- Pr√≥ximos pasos -->
        <div class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <h3 class="card-title text-primary mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-6 w-6"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                    Pr√≥ximos Pasos
                </h3>
                <div class="alert alert-warning mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="stroke-current shrink-0 h-6 w-6"
                         fill="none"
                         viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                    </svg>
                    <div>
                        <div class="font-bold">Transacci√≥n Pendiente de Procesamiento</div>
                        <div class="text-sm">
                            Esta transacci√≥n requiere procesamiento adicional seg√∫n el m√©todo de pago/cobro seleccionado.
                        </div>
                    </div>
                </div>
                <!-- Instrucciones seg√∫n el m√©todo -->
                {% if metodo_pago == 'efectivo' or metodo_cobro == 'efectivo' %}
                    <div class="steps steps-vertical lg:steps-horizontal w-full">
                        <div class="step step-primary">Transacci√≥n Creada</div>
                        <div class="step">Presentarse en Sucursal</div>
                        <div class="step">Verificaci√≥n de Identidad</div>
                        <div class="step">Procesamiento de Pago</div>
                        <div class="step">Transacci√≥n Completada</div>
                    </div>
                    <div class="mt-4 p-4 bg-info bg-opacity-20 rounded-lg">
                        <div class="font-semibold mb-2">Instrucciones para Pago en Efectivo:</div>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li>Presentarse en cualquiera de nuestras sucursales</li>
                            <li>Traer documento de identidad v√°lido</li>
                            <li>
                                Proporcionar el ID de transacci√≥n: <code class="bg-base-300 px-2 py-1 rounded">{{ transaccion.id_transaccion }}</code>
                            </li>
                            <li>Realizar el pago correspondiente</li>
                        </ul>
                    </div>
                {% elif 'tarjeta' in metodo_pago or 'tarjeta' in metodo_cobro %}
                    <div class="steps steps-vertical lg:steps-horizontal w-full">
                        <div class="step step-primary">Transacci√≥n Creada</div>
                        <div class="step">Procesamiento Autom√°tico</div>
                        <div class="step">Verificaci√≥n del Pago</div>
                        <div class="step">Transacci√≥n Completada</div>
                    </div>
                    <div class="mt-4 p-4 bg-warning bg-opacity-20 rounded-lg">
                        <div class="font-semibold mb-2">Procesamiento con Tarjeta:</div>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li>El procesamiento ser√° autom√°tico</li>
                            <li>Recibir√° notificaciones por email</li>
                            <li>Tiempo estimado: 2-5 minutos</li>
                            <li>En caso de problemas, contacte al servicio al cliente</li>
                        </ul>
                    </div>
                {% elif 'cuenta' in metodo_pago or 'cuenta' in metodo_cobro %}
                    <div class="steps steps-vertical lg:steps-horizontal w-full">
                        <div class="step step-primary">Transacci√≥n Creada</div>
                        <div class="step">Verificaci√≥n Bancaria</div>
                        <div class="step">Transferencia</div>
                        <div class="step">Transacci√≥n Completada</div>
                    </div>
                    <div class="mt-4 p-4 bg-success bg-opacity-20 rounded-lg">
                        <div class="font-semibold mb-2">Transferencia Bancaria:</div>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li>Se procesar√° la transferencia bancaria</li>
                            <li>Tiempo estimado: 1-2 horas h√°biles</li>
                            <li>Recibir√° confirmaci√≥n por email</li>
                            <li>Verifique los fondos disponibles en su cuenta</li>
                        </ul>
                    </div>
                {% elif 'billetera' in metodo_pago or 'billetera' in metodo_cobro %}
                    <div class="steps steps-vertical lg:steps-horizontal w-full">
                        <div class="step step-primary">Transacci√≥n Creada</div>
                        <div class="step">Autorizaci√≥n de Billetera</div>
                        <div class="step">Procesamiento</div>
                        <div class="step">Transacci√≥n Completada</div>
                    </div>
                    <div class="mt-4 p-4 bg-accent bg-opacity-20 rounded-lg">
                        <div class="font-semibold mb-2">Billetera Electr√≥nica:</div>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li>Revisar notificaciones en su billetera electr√≥nica</li>
                            <li>Autorizar la transacci√≥n si es requerido</li>
                            <li>Tiempo estimado: 5-15 minutos</li>
                            <li>Pueden aplicar comisiones adicionales del proveedor</li>
                        </ul>
                    </div>
                {% else %}
                    <div class="steps steps-vertical lg:steps-horizontal w-full">
                        <div class="step step-primary">Transacci√≥n Creada</div>
                        <div class="step">En Proceso</div>
                        <div class="step">Verificaci√≥n</div>
                        <div class="step">Transacci√≥n Completada</div>
                    </div>
                    <div class="mt-4 p-4 bg-base-200 rounded-lg">
                        <div class="font-semibold mb-2">Procesamiento General:</div>
                        <p class="text-sm">Su transacci√≥n est√° siendo procesada. Recibir√° notificaciones sobre el estado de la misma.</p>
                    </div>
                {% endif %}
            </div>
        </div>
        <!-- Acciones -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h3 class="card-title text-primary mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-6 w-6"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4" />
                    </svg>
                    ¬øQu√© deseas hacer ahora?
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <a href="{% url 'transacciones:lista' %}" class="btn btn-primary btn-lg">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="h-6 w-6"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        <div class="text-left">
                            <div class="font-semibold">Mis Transacciones</div>
                            <div class="text-xs opacity-60">Ver historial</div>
                        </div>
                    </a>
                    <a href="{% url 'transacciones:realizar_transaccion' %}"
                       class="btn btn-outline btn-lg">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="h-6 w-6"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <div class="text-left">
                            <div class="font-semibold">Nueva Transacci√≥n</div>
                            <div class="text-xs opacity-60">Realizar otra</div>
                        </div>
                    </a>
                    <button id="btnPagarTransaccion"
                            onclick="iniciarProcesoBancario('{{ transaccion.id_transaccion }}')"
                            class="btn btn-success btn-lg">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="h-6 w-6"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <div class="text-left">
                            <div class="font-semibold">Pagar Transacci√≥n</div>
                            <div class="text-xs opacity-60">Procesar pago</div>
                        </div>
                    </button>
                    <button onclick="cancelarTransaccion('{{ transaccion.id_transaccion }}')"
                            class="btn btn-error btn-outline btn-lg">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="h-6 w-6"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        <div class="text-left">
                            <div class="font-semibold">Cancelar</div>
                            <div class="text-xs opacity-60">Esta transacci√≥n</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
        <!-- Informaci√≥n adicional -->
        <div class="alert alert-info mt-6">
            <svg xmlns="http://www.w3.org/2000/svg"
                 fill="none"
                 viewBox="0 0 24 24"
                 class="stroke-current shrink-0 w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                </path>
            </svg>
            <div>
                <div class="font-bold">Importante</div>
                <div class="text-sm">
                    Guarde el ID de transacci√≥n: <code class="bg-base-300 px-2 py-1 rounded">{{ transaccion.id_transaccion }}</code>
                    para cualquier consulta o reclamo posterior.
                </div>
            </div>
        </div>
    </div>
    <!-- Token CSRF -->
    {% csrf_token %}
    <!-- Modal de confirmaci√≥n para cancelar -->
    <dialog id="cancelModal" class="modal">
        <div class="modal-box w-11/12 max-w-md">
            <form method="dialog">
                <button type="button"
                        class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
                        onclick="document.getElementById('cancelModal').close()">‚úï</button>
            </form>
            <h3 class="font-bold text-lg text-red-600 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="h-6 w-6 inline mr-2"
                     fill="none"
                     viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
                ¬øCancelar Transacci√≥n?
            </h3>
            <p class="mb-6 text-gray-700">
                ¬øEst√°s seguro que deseas cancelar la transacci√≥n
                <span class="font-mono font-semibold bg-gray-100 px-2 py-1 rounded">{{ transaccion.id_transaccion }}</span>?
                Esta acci√≥n no se puede deshacer y la transacci√≥n quedar√° marcada como cancelada.
            </p>
            <div class="modal-action mt-4 flex justify-end space-x-2">
                <button id="confirmCancelBtn" class="btn btn-error">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-4 w-4 mr-1"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    S√≠, cancelar transacci√≥n
                </button>
                <button type="button"
                        class="btn btn-ghost"
                        onclick="document.getElementById('cancelModal').close()">No, mantener</button>
            </div>
        </div>
    </dialog>
    <!-- Popup de simulaci√≥n bancaria se abre en ventana separada -->
</dialog>
<script>
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                showToast('ID copiado al portapapeles!', 'success');
            }).catch(function() {
                showToast('Error al copiar al portapapeles', 'error');
            });
        }

        function cancelarTransaccion(transaccionId) {
            // Mostrar modal de confirmaci√≥n
            document.getElementById('cancelModal').showModal();
            
            // Configurar el bot√≥n de confirmaci√≥n
            document.getElementById('confirmCancelBtn').onclick = function() {
                // Deshabilitar el bot√≥n mientras se procesa
                const cancelBtn = document.getElementById('confirmCancelBtn');
                const originalText = cancelBtn.innerHTML;
                cancelBtn.disabled = true;
                cancelBtn.innerHTML = `
                    <span class="loading loading-spinner loading-sm"></span>
                    Cancelando...
                `;
                
                // Realizar la petici√≥n de cancelaci√≥n
                fetch(`/transacciones/api/cancelar-transaccion/${transaccionId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('cancelModal').close();
                    if (data.success) {
                        // Mostrar mensaje de √©xito y redirigir
                        showToast('Transacci√≥n cancelada exitosamente', 'success');
                        
                        setTimeout(() => {
                            window.location.href = '/transacciones/';
                        }, 2000);
                    } else {
                        // Mostrar mensaje de error
                        showToast(`Error: ${data.message || 'No se pudo cancelar la transacci√≥n'}`, 'error');
                        
                        // Restaurar bot√≥n
                        cancelBtn.disabled = false;
                        cancelBtn.innerHTML = originalText;
                    }
                })
                .catch(error => {
                    document.getElementById('cancelModal').close();
                    console.error('Error al cancelar transacci√≥n:', error);
                    showToast(`Error de conexi√≥n: ${error.message}`, 'error');
                    
                    // Restaurar bot√≥n
                    cancelBtn.disabled = false;
                    cancelBtn.innerHTML = originalText;
                });
            };
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast toast-top toast-end z-50';
            const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-error' : 'alert-info';
            toast.innerHTML = `
                <div class="alert ${alertClass} shadow-lg">
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, type === 'success' ? 3000 : 5000);
        }

        let ventanaBanco = null;
        let transaccionActual = null;

        function iniciarProcesoBancario(transaccionId) {
            transaccionActual = transaccionId;
            
            // Deshabilitar el bot√≥n
            const btnPagar = document.getElementById('btnPagarTransaccion');
            btnPagar.disabled = true;
            btnPagar.innerHTML = `
                <span class="loading loading-spinner loading-sm"></span>
                <div class="text-left">
                    <div class="font-semibold">Procesando...</div>
                    <div class="text-xs opacity-60">Abriendo banco</div>
                </div>
            `;
            
            // Cerrar ventana anterior si existe
            if (ventanaBanco && !ventanaBanco.closed) {
                ventanaBanco.close();
            }
            
            // Configurar la ventana emergente modal
            const ancho = 700;
            const alto = 600;
            const izquierda = (screen.width - ancho) / 2;
            const arriba = (screen.height - alto) / 2;
            
            const opciones = `
                width=${ancho},
                height=${alto},
                left=${izquierda},
                top=${arriba},
                scrollbars=no,
                resizable=no,
                toolbar=no,
                menubar=no,
                location=no,
                directories=no,
                status=no,
                modal=yes,
                alwaysRaised=yes,
                dependent=yes
            `;
            
            // Abrir ventana del banco simulado
            const url = `/transacciones/popup-banco/${transaccionId}/`;
            ventanaBanco = window.open(url, 'BancoSimulado', opciones);
            
            if (ventanaBanco) {
                // Focalizar la ventana y hacerla modal
                ventanaBanco.focus();
                
                // Bloquear interacci√≥n con la p√°gina padre
                bloquearPaginaPadre();
                
                // Verificar si la ventana se cerr√≥ manualmente
                const verificarVentana = setInterval(() => {
                    if (ventanaBanco.closed) {
                        clearInterval(verificarVentana);
                        console.log('Ventana del banco cerrada por el usuario');
                        desbloquearPaginaPadre();
                        restaurarBotonPagar();
                    }
                }, 1000);
                
                // Mantener foco en la ventana del banco
                const mantenerFoco = setInterval(() => {
                    if (ventanaBanco && !ventanaBanco.closed) {
                        ventanaBanco.focus();
                    } else {
                        clearInterval(mantenerFoco);
                    }
                }, 500);
                
                showToast('Redirigiendo al banco para procesar el pago...', 'info');
            } else {
                // Error al abrir ventana (bloqueador de popups)
                showToast('Error: No se pudo abrir la ventana del banco. Revisa el bloqueador de ventanas emergentes.', 'error');
                restaurarBotonPagar();
            }
        }

        // Escuchar mensajes de la ventana emergente
        window.addEventListener('message', function(event) {
            // Verificar que el mensaje venga de nuestra ventana
            if (event.source === ventanaBanco) {
                switch(event.data.type) {
                    case 'pagoCompletado':
                        handlePagoCompletado(event.data);
                        break;
                    case 'abrirTauserRetiro':
                        handleAbrirTauserRetiro(event.data);
                        break;
                    case 'errorBanco':
                        handleErrorBanco(event.data);
                        break;
                    case 'reintentarPago':
                        handleReintentarPago();
                        break;
                    case 'ventanaCerrada':
                        handleVentanaCerrada(event.data);
                        break;
                    case 'ventanaCerradaSinCompletar':
                        handleVentanaCerradaSinCompletar(event.data);
                        break;
                    case 'transaccionCompletada':
                        handleTransaccionCompletada(event.data);
                        break;
                }
            }
        });

        function handlePagoCompletado(data) {
            console.log('Pago completado exitosamente:', data);
            
            // Cerrar la ventana si no se cerr√≥ autom√°ticamente
            if (ventanaBanco && !ventanaBanco.closed) {
                ventanaBanco.close();
            }
            
            // Desbloquear p√°gina padre
            desbloquearPaginaPadre();
            
            // Mostrar mensaje y redirigir instant√°neamente
            showToast('Pago procesado exitosamente!', 'success');
            window.location.href = '/transacciones/';
        }

        function handleAbrirTauserRetiro(data) {
            console.log('Abriendo popup TAUSER para retiro:', data);
            
            // Cerrar la ventana del banco si a√∫n est√° abierta
            if (ventanaBanco && !ventanaBanco.closed) {
                ventanaBanco.close();
            }
            
            // Abrir popup para c√≥digo TAUSER de retiro
            const urlTauser = `/transacciones/popup-tauser-retiro/${data.transaccionId}/`;
            ventanaBanco = window.open(
                urlTauser, 
                'tauserRetiro', 
                'width=600,height=700,scrollbars=yes,resizable=yes,modal=yes,dependent=yes,alwaysRaised=yes'
            );
            
            if (!ventanaBanco) {
                showToast('Error: No se pudo abrir la ventana TAUSER. Revisa el bloqueador de ventanas emergentes.', 'error');
                desbloquearPaginaPadre();
                restaurarBotonPagar();
            }
        }

        function handleErrorBanco(data) {
            console.log('Error en el banco:', data);
            showToast(`Error del banco: ${data.mensaje}`, 'error');
            
            // Cerrar la ventana si no se cerr√≥ autom√°ticamente
            if (ventanaBanco && !ventanaBanco.closed) {
                ventanaBanco.close();
            }
            
            // Desbloquear p√°gina padre y restaurar el bot√≥n
            desbloquearPaginaPadre();
            restaurarBotonPagar();
        }

        function handleReintentarPago() {
            console.log('Usuario quiere reintentar el pago');
            
            // Cerrar ventana actual
            if (ventanaBanco && !ventanaBanco.closed) {
                ventanaBanco.close();
            }
            
            // Desbloquear p√°gina padre temporalmente
            desbloquearPaginaPadre();
            
            // Reintentar despu√©s de un breve delay
            setTimeout(() => {
                iniciarProcesoBancario(transaccionActual);
            }, 1000);
        }

        function handleVentanaCerrada(data) {
            console.log('Ventana cerrada despu√©s de completar:', data);
            // No hacer nada especial, el proceso ya se complet√≥
        }

        function handleVentanaCerradaSinCompletar(data) {
            console.log('Ventana cerrada sin completar el proceso:', data);
            showToast('Proceso bancario cancelado por el usuario', 'warning');
            desbloquearPaginaPadre();
            restaurarBotonPagar();
        }

        function handleTransaccionCompletada(data) {
            console.log('Transacci√≥n completada exitosamente:', data);
            
            // Cerrar la ventana si no se cerr√≥ autom√°ticamente
            if (ventanaBanco && !ventanaBanco.closed) {
                ventanaBanco.close();
            }
            
            // Desbloquear p√°gina padre
            desbloquearPaginaPadre();
            
            // Mostrar mensaje seg√∫n el m√©todo
            if (data.metodo === 'tauser') {
                showToast('C√≥digo TAUSER generado exitosamente!', 'success');
            } else {
                showToast('Transacci√≥n completada exitosamente!', 'success');
            }
            
            // Redirigir a la lista de transacciones
            window.location.href = '/transacciones/';
        }

        function restaurarBotonPagar() {
            const btnPagar = document.getElementById('btnPagarTransaccion');
            btnPagar.disabled = false;
            btnPagar.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <div class="text-left">
                    <div class="font-semibold">Pagar Transacci√≥n</div>
                    <div class="text-xs opacity-60">Procesar pago</div>
                </div>
            `;
        }

        function bloquearPaginaPadre() {
            // Crear overlay para bloquear interacci√≥n
            const overlay = document.createElement('div');
            overlay.id = 'modalOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 9998;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(2px);
            `;
            
            // Mensaje de ventana activa
            const mensaje = document.createElement('div');
            mensaje.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                max-width: 400px;
                margin: 20px;
            `;
            mensaje.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 20px; font-weight: bold; color: #3b82f6;">$</div>
                <h3 style="margin: 0 0 15px 0; color: #1f2937; font-size: 1.5rem;">Procesando Pago</h3>
                <p style="margin: 0; color: #6b7280; line-height: 1.5;">
                    La ventana del banco est√° activa.<br>
                    Complete el proceso de pago para continuar.
                </p>
            `;
            
            overlay.appendChild(mensaje);
            document.body.appendChild(overlay);
            
            // Prevenir scroll
            document.body.style.overflow = 'hidden';
        }

        function desbloquearPaginaPadre() {
            const overlay = document.getElementById('modalOverlay');
            if (overlay) {
                overlay.remove();
            }
            
            // Restaurar scroll
            document.body.style.overflow = '';
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            // Si no encuentra la cookie, intenta obtenerla del input hidden
            if (!cookieValue) {
                const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
                if (csrfInput) {
                    cookieValue = csrfInput.value;
                }
            }
            return cookieValue;
        }
</script>
{% endblock content %}

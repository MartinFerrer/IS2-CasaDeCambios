{% extends "base.html" %}
{% load static %}
{% block title %}
    Realizar Transacción
{% endblock title %}
{% block content %}
    <div class="container mx-auto p-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold">Realizar Transacción de Cambio de Divisas</h2>
            <a href="{% url 'presentacion:home' %}" class="btn btn-outline">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="h-5 w-5"
                     fill="none"
                     viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                Volver al inicio
            </a>
        </div>
        <!-- Información del Cliente -->
        {% if user.is_authenticated and request.cliente %}
            <div class="alert alert-info mb-6">
                <svg xmlns="http://www.w3.org/2000/svg"
                     fill="none"
                     viewBox="0 0 24 24"
                     class="stroke-current shrink-0 w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                    </path>
                </svg>
                <span>Transacción para el cliente: <strong>{{ request.cliente.nombre }}</strong> ({{ request.cliente.ruc }})</span>
            </div>
        {% elif user.is_authenticated %}
            <div class="alert alert-warning mb-6">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="stroke-current shrink-0 h-6 w-6"
                     fill="none"
                     viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
                <span>No tienes clientes asociados. Contacta a un operador para asociar clientes a tu cuenta.</span>
            </div>
        {% else %}
            <div class="alert alert-info mb-6">
                <svg xmlns="http://www.w3.org/2000/svg"
                     fill="none"
                     viewBox="0 0 24 24"
                     class="stroke-current shrink-0 w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                    </path>
                </svg>
                <span>Para realizar transacciones, inicia sesión con tu cuenta.</span>
            </div>
        {% endif %}
        <!-- Formulario de Transacción -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <form id="transaction-form">
                    {% csrf_token %}
                    <div class="grid grid-cols-1 gap-6">
                        <!-- Tipo de Operación (full width) -->
                        <div class="form-control col-span-full">
                            <label class="label">
                                <span class="label-text text-lg font-semibold text-primary">¿Qué desea hacer?</span>
                            </label>
                            <div class="flex gap-4 mt-2">
                                <label class="label cursor-pointer">
                                    <input type="radio"
                                           name="tipo_operacion"
                                           value="compra"
                                           class="radio radio-primary"
                                           checked>
                                    <span class="label-text ml-2">Quiero Comprar Divisa</span>
                                </label>
                                <label class="label cursor-pointer">
                                    <input type="radio"
                                           name="tipo_operacion"
                                           value="venta"
                                           class="radio radio-primary">
                                    <span class="label-text ml-2">Quiero Vender Divisa</span>
                                </label>
                            </div>
                        </div>
                        <!-- Fields in two columns: labels (left) and controls (right) -->
                        <div class="grid grid-cols-1 md:grid-cols-3 items-start gap-4">
                            <!-- Label column (narrow) -->
                            <div class="space-y-6 text-left md:col-span-1 md:w-36">
                                <div class="pt-2">
                                    <label class="label">
                                        <span class="label-text" id="divisa-label">Quiero</span>
                                    </label>
                                </div>
                                <div class="pt-2">
                                    <label class="label">
                                        <span class="label-text" id="monto-label">Monto que Tengo</span>
                                    </label>
                                </div>
                                <div class="pt-2">
                                    <label class="label">
                                        <span class="label-text">Método de Pago</span>
                                    </label>
                                </div>
                                <div class="pt-2">
                                    <label class="label">
                                        <span class="label-text">Método de Cobro</span>
                                    </label>
                                </div>
                            </div>
                            <!-- Controls column (wide) -->
                            <div class="space-y-4 md:col-span-2">
                                <div>
                                    <select id="divisa-select"
                                            class="select select-bordered w-full text-left ml-0"
                                            required>
                                        <option value="">Seleccione una divisa</option>
                                        {% for divisa in divisas %}
                                            <option value="{{ divisa.codigo }}">{{ divisa.codigo }} - {{ divisa.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <input type="number"
                                           id="monto-input"
                                           name="monto"
                                           pattern="^\d+$"
                                           min="1"
                                           step="1"
                                           class="input input-bordered w-full text-left ml-0 validator"
                                           placeholder="Ingrese el monto entero (mínimo 1)"
                                           title="El monto debe ser un número entero"
                                           required>
                                    <p id="monto-error"
                                       class="validator-hint text-error text-sm mt-1 hidden">
                                        El monto debe ser un número entero
                                    </p>
                                </div>
                                <div>
                                    <select id="metodo-pago-select"
                                            class="select select-bordered w-full text-left ml-0"
                                            required>
                                        <option value="">Seleccione método de pago</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="metodo-cobro-select"
                                            class="select select-bordered w-full text-left ml-0"
                                            required>
                                        <option value="efectivo" selected>Efectivo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <!-- Resultados de la Simulación -->
        <div id="simulation-results"
             class="card bg-base-100 shadow-lg mt-6 hidden">
            <div class="card-body">
                <h3 class="card-title text-primary">Resultado de la Simulación</h3>
                <div class="flex justify-center">
                    <div class="w-full md:w-2/3 lg:w-1/2 text-left space-y-3">
                        <p>
                            <strong id="monto-original-label">Monto que Tengo:</strong>
                            <span id="monto-original-val">0</span> <span id="moneda-origen-val">-</span>
                        </p>
                        <p>
                            <strong>Tasa de Cambio Efectiva:</strong> <span id="tasa-val">-</span>
                        </p>
                        <p class="text-2xl font-extrabold text-primary">
                            <strong id="monto-final-label">Monto a Recibir:</strong>
                            <span id="monto-final-val">0</span> <span id="moneda-destino-val">PYG</span>
                        </p>
                    </div>
                </div>
                <!-- Sección colapsable para desglose de comisiones -->
                <div class="collapse collapse-arrow border border-base-300 bg-base-100 rounded-box mt-4">
                    <input type="checkbox" />
                    <div class="collapse-title font-medium">Comisión (ver desglose)</div>
                    <div class="collapse-content" id="commission-breakdown">
                        <p>
                            <strong>Comisión Base:</strong> <span id="comision-base-val">0</span>
                        </p>
                        <p>
                            <strong>Descuento por Segmento:</strong> <span id="descuento-val">0</span>%
                        </p>
                        <p>
                            <strong>Comisión Final:</strong> <span id="comision-final-val">0</span>
                        </p>
                        <p id="comision-medio-pago-section" class="hidden">
                            <strong>Comisión Medio de Pago:</strong> <span id="comision-medio-pago-val">0</span> (<span id="comision-medio-pago-pct">0</span>%)
                        </p>
                        <div id="stripe-fees-section" class="hidden border-t pt-2 mt-2">
                            <p class="text-sm font-medium text-purple-700 mb-1">💳 Comisiones Stripe (Tarjeta Internacional):</p>
                            <p class="text-sm pl-4">
                                • <strong>Comisión Variable:</strong> <span id="stripe-variable-fee">0</span> PYG (2.9%)
                            </p>
                            <p class="text-sm pl-4">
                                • <strong>Comisión Fija:</strong> <span id="stripe-fixed-fee">0</span> PYG (0.30 USD)
                            </p>
                            <p class="text-sm pl-4 font-medium text-purple-800">
                                <strong>Total Stripe:</strong> <span id="stripe-total-fee">0</span> PYG
                            </p>
                        </div>
                    </div>
                </div>
                <!-- Advertencia para billeteras electrónicas -->
                <div id="wallet-warning" class="alert alert-warning mt-4 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="stroke-current shrink-0 h-6 w-6"
                         fill="none"
                         viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                    </svg>
                    <span>Advertencia: Las billeteras electrónicas pueden cobrar comisiones adicionales por parte del proveedor, no incluidas en esta simulación.</span>
                </div>
                <!-- Botón para proceder -->
                <div class="form-control mt-6">
                    {% if user.is_authenticated %}
                        <button id="proceed-btn" class="btn btn-success w-full" disabled>Realizar Transacción</button>
                    {% else %}
                        <button class="btn btn-success w-full" disabled>Realizar Transacción</button>
                        <p class="text-sm text-gray-600 mt-2 text-center">
                            Para realizar transacciones debe iniciar sesión y tener un cliente asociado.
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- Notas Adicionales -->
        <div class="alert alert-info mt-6">
            <svg xmlns="http://www.w3.org/2000/svg"
                 fill="none"
                 viewBox="0 0 24 24"
                 class="stroke-current shrink-0 w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                </path>
            </svg>
            <span>Las tasas de cambio y comisiones son estimativas y pueden variar. Proceda a realizar una transacción para confirmar.</span>
        </div>
        <!-- Modal de Confirmación -->
        <div id="confirmation-modal" class="modal">
            <div class="modal-box max-w-lg">
                <!-- Header -->
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-xl text-primary">Confirmar Transacción</h3>
                    <button id="close-modal" class="btn btn-sm btn-circle btn-ghost">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="h-6 w-6"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <!-- Content -->
                <div class="bg-base-200 rounded-lg p-4 mb-6">
                    <div class="grid grid-cols-1 gap-3">
                        <div class="flex justify-between items-center p-2 bg-base-100 rounded">
                            <span class="font-semibold text-gray-600">Tipo de Operación:</span>
                            <span id="modal-tipo" class="font-bold text-primary"></span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-base-100 rounded">
                            <span id="modal-divisa-label" class="font-semibold text-gray-600">Divisa:</span>
                            <span id="modal-divisa" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-base-100 rounded">
                            <span class="font-semibold text-gray-600">Monto:</span>
                            <span id="modal-monto" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-success text-success-content rounded">
                            <span id="modal-total-label" class="font-semibold">Total a Pagar/Recibir:</span>
                            <span id="modal-total" class="font-bold text-lg"></span>
                        </div>
                        <div class="divider my-2"></div>
                        <div class="flex justify-between items-center p-2 bg-base-100 rounded">
                            <span class="font-semibold text-gray-600">Método de Pago:</span>
                            <span id="modal-metodo-pago" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-base-100 rounded">
                            <span class="font-semibold text-gray-600">Método de Cobro:</span>
                            <span id="modal-metodo-cobro" class="font-bold"></span>
                        </div>
                    </div>
                </div>
                <!-- Warning -->
                <div class="alert alert-warning mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="stroke-current shrink-0 h-6 w-6"
                         fill="none"
                         viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                    </svg>
                    <span class="text-sm">La transacción quedará pendiente hasta que se procese el pago correspondiente.</span>
                </div>
                <!-- Actions -->
                <div class="modal-action">
                    <button id="cancel-transaction" class="btn btn-outline">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="h-4 w-4 mr-2"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        Cancelar
                    </button>
                    <button id="confirm-transaction" class="btn btn-success">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="h-4 w-4 mr-2"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Confirmar Transacción
                    </button>
                </div>
            </div>
        </div>
        <!-- Modal de Pago Stripe -->
        <div id="stripe-payment-modal" class="modal">
            <div class="modal-box max-w-md">
                <h3 class="font-bold text-lg mb-4">💳 Pago con Tarjeta Internacional</h3>
                <div id="stripe-error" class="alert alert-error mb-4 hidden">
                    <span id="stripe-error-message"></span>
                </div>
                <form id="stripe-payment-form">
                    <!-- Elemento de Stripe -->
                    <div id="stripe-card-element"
                         class="p-3 border border-gray-300 rounded-lg mb-4">
                        <!-- Stripe Elements insertará aquí el formulario de tarjeta -->
                    </div>
                    <!-- Información del pago -->
                    <div class="bg-base-200 p-4 rounded-lg mb-4">
                        <div class="text-sm space-y-1">
                            <div class="flex justify-between">
                                <span>Monto Transacción:</span>
                                <span id="stripe-amount-display" class="font-bold"></span>
                            </div>
                            <hr class="my-2">
                            <div class="text-xs text-purple-700 font-medium">Comisiones Stripe:</div>
                            <div class="flex justify-between text-xs pl-2">
                                <span>• Comisión Variable (2.9%):</span>
                                <span id="stripe-modal-variable-fee" class="font-bold text-orange-600">-</span>
                            </div>
                            <div class="flex justify-between text-xs pl-2">
                                <span>• Comisión Fija (0.30 USD):</span>
                                <span id="stripe-modal-fixed-fee" class="font-bold text-orange-600">-</span>
                            </div>
                            <div class="flex justify-between text-xs font-bold text-purple-800 border-t pt-1">
                                <span>Total Comisiones:</span>
                                <span id="stripe-modal-total-fees">-</span>
                            </div>
                            <hr class="my-2">
                            <div class="flex justify-between font-bold text-lg">
                                <span>Total a Pagar:</span>
                                <span id="stripe-modal-grand-total" class="text-primary">-</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>Procesado por:</span>
                                <span class="font-bold">Stripe</span>
                            </div>
                        </div>
                    </div>
                    <!-- Botones -->
                    <div class="modal-action">
                        <button type="button" id="cancel-stripe-payment" class="btn btn-outline">Cancelar</button>
                        <button type="submit" id="confirm-stripe-payment" class="btn btn-primary">
                            <span class="loading loading-spinner loading-sm hidden" id="stripe-loading"></span>
                            Pagar Ahora
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <script src="https://js.stripe.com/v3/"></script>
        <!-- Módulos JavaScript para transacciones -->
        <script src="{% static 'js/transacciones/formatters.js' %}"></script>
        <script src="{% static 'js/transacciones/validators.js' %}"></script>
        <script src="{% static 'js/transacciones/business-logic.js' %}"></script>
        <script>
    (function() {
        // Importar funciones desde módulos
        const { formatNumber, formatRate, parseInputNumber, formatInputNumber } = window.TransaccionesFormatters;
        const { validateIntegerInput, setupIntegerValidation } = window.TransaccionesValidators;
        const { loadDivisasFromAPI, calculateExchangeAmount } = window.TransaccionesBusinessLogic;
        // Elementos del DOM
        const tipoOperacionInputs = document.querySelectorAll('input[name="tipo_operacion"]');
        const divisaSelect = document.getElementById('divisa-select');
        const montoInput = document.getElementById('monto-input');
        const metodoPagoSelect = document.getElementById('metodo-pago-select');
        const metodoCobroSelect = document.getElementById('metodo-cobro-select');

        // Función local para obtener tipo de operación desde radio buttons
        function getTipoOperacion() {
            const radioChecked = document.querySelector('input[name="tipo_operacion"]:checked');
            return radioChecked ? radioChecked.value : 'compra';
        }

        // Configuración de Stripe
        const stripeKey = '{{ STRIPE_PUBLISHABLE_KEY }}';
        console.log('Stripe key loaded:', stripeKey ? 'OK' : 'MISSING');

        if (!stripeKey) {
            console.error('Stripe publishable key is missing!');
        }

        const stripe = Stripe(stripeKey);
        const elements = stripe.elements();

        // Elementos del modal de Stripe
        const stripeModal = document.getElementById('stripe-payment-modal');
        const stripeForm = document.getElementById('stripe-payment-form');
        const stripeCardElement = elements.create('card', {
            style: {
                base: {
                    fontSize: '16px',
                    color: '#424770',
                    '::placeholder': {
                        color: '#aab7c4',
                    },
                },
            },
        });
        stripeCardElement.mount('#stripe-card-element');

        // Verificar que el elemento se montó correctamente
        stripeCardElement.on('ready', function() {
            console.log('Stripe card element is ready');
        });

        stripeCardElement.on('change', function(event) {
            if (event.error) {
                console.error('Stripe element error:', event.error);
                showStripeError(event.error.message);
            } else {
                hideStripeError();
            }
        });

        const stripeErrorDiv = document.getElementById('stripe-error');
        const stripeErrorMessage = document.getElementById('stripe-error-message');
        const cancelStripeBtn = document.getElementById('cancel-stripe-payment');
        const confirmStripeBtn = document.getElementById('confirm-stripe-payment');
        const stripeLoading = document.getElementById('stripe-loading');
        const stripeAmountDisplay = document.getElementById('stripe-amount-display');
        const stripeModalVariableFee = document.getElementById('stripe-modal-variable-fee');
        const stripeModalFixedFee = document.getElementById('stripe-modal-fixed-fee');
        const stripeModalTotalFees = document.getElementById('stripe-modal-total-fees');
        const stripeModalGrandTotal = document.getElementById('stripe-modal-grand-total');

        let currentTransactionId = null;

        // Labels dinámicos
        const divisaLabel = document.getElementById('divisa-label');
        const montoLabel = document.getElementById('monto-label');

        // Elementos de resultados
        const resultsCard = document.getElementById('simulation-results');
        const montoOriginalLabel = document.getElementById('monto-original-label');
        const montoFinalLabel = document.getElementById('monto-final-label');
        const montoOriginalVal = document.getElementById('monto-original-val');
        const monedaOrigenVal = document.getElementById('moneda-origen-val');
        const tasaVal = document.getElementById('tasa-val');
        const montoFinalVal = document.getElementById('monto-final-val');
        const monedaDestinoVal = document.getElementById('moneda-destino-val');
        const comisionBaseVal = document.getElementById('comision-base-val');
        const descuentoVal = document.getElementById('descuento-val');
        const comisionFinalVal = document.getElementById('comision-final-val');
        const comisionMedioPagoSection = document.getElementById('comision-medio-pago-section');
        const comisionMedioPagoVal = document.getElementById('comision-medio-pago-val');
        const comisionMedioPagoPct = document.getElementById('comision-medio-pago-pct');
        const stripeFeeSection = document.getElementById('stripe-fees-section');
        const stripeVariableFee = document.getElementById('stripe-variable-fee');
        const stripeFixedFee = document.getElementById('stripe-fixed-fee');
        const stripeTotalFee = document.getElementById('stripe-total-fee');
        const walletWarning = document.getElementById('wallet-warning');
        const proceedBtn = document.getElementById('proceed-btn');

        // Modal elements
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmBtn = document.getElementById('confirm-transaction');
        const cancelBtn = document.getElementById('cancel-transaction');
        const closeModalBtn = document.getElementById('close-modal');

        // Estado global
        const currentCliente = {% if request.cliente %}{{ request.cliente.id }}{% else %}null{% endif %};
        let availableDivisas = [];
        let lastSimulationData = null;

        // Configuración específica para formateo
        const isoDecimals = { PYG: 0, USD: 2, EUR: 2, BRL: 2 };

        // Función adaptada para usar el módulo de formatters con configuración específica
        function formatNumberWithCurrency(value, currency) {
            return formatNumber(value, isoDecimals[currency] || 2);
        }

        // Función adaptada para labels usando lógica del módulo business-logic
        function updateLabelsLocal() {
            const tipo = getTipoOperacion();
            const labelMap = {
                compra: {
                    divisa: 'Quiero',
                    monto: 'Monto que Deseo',
                    montoOriginal: 'Monto que Deseo:',
                    montoFinal: 'Total a Pagar:'
                },
                venta: {
                    divisa: 'Tengo',
                    monto: 'Monto que Tengo',
                    montoOriginal: 'Monto que Tengo:',
                    montoFinal: 'Monto a Recibir:'
                }
            };

            const labels = labelMap[tipo];
            divisaLabel.textContent = labels.divisa;
            montoLabel.textContent = labels.monto;
            montoOriginalLabel.textContent = labels.montoOriginal;
            montoFinalLabel.textContent = labels.montoFinal;
        }

        // Objeto para almacenar divisas disponibles
        const divisasStorage = { divisas: [] };

        // Función local que usa el módulo loadDivisasFromAPI
        async function loadDivisasLocal() {
            const success = await loadDivisasFromAPI(
                divisaSelect,
                '{% url "transacciones:api_divisas_disponibles" %}',
                divisasStorage
            );

            // Actualizar referencia para compatibilidad
            if (success) {
                availableDivisas = divisasStorage.divisas;
            }
        }

        // Cargar medios de pago del cliente
        async function loadMediosPago() {
            if (!currentCliente) {
                resetMediosPago();
                return;
            }

            try {
                const tipo = getTipoOperacion();
                const response = await fetch(`{% url "transacciones:api_medios_pago_cliente" cliente_id=0 %}`.replace('0', currentCliente) + `?tipo=${tipo}`);
                const data = await response.json();

                // Limpiar y rellenar método de pago
                metodoPagoSelect.innerHTML = '';

                // Agregar opción vacía si hay múltiples métodos digitales
                const metodosDigitales = data.medios_pago.filter(medio => medio.id !== 'efectivo');
                if (metodosDigitales.length > 1) {
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = 'Seleccione método de pago';
                    metodoPagoSelect.appendChild(emptyOption);
                }

                let hasEfectivoPago = false;
                data.medios_pago.forEach((medio, index) => {
                    const optionPago = document.createElement('option');
                    optionPago.value = medio.id;
                    optionPago.textContent = `${medio.nombre} (${medio.comision}%)`;
                    optionPago.dataset.comision = medio.comision;

                    // Solo autoseleccionar si hay efectivo O si hay solo un método digital
                    if (medio.id === 'efectivo') {
                        hasEfectivoPago = true;
                        optionPago.selected = true;
                    } else if (metodosDigitales.length === 1 && index === 0 && !hasEfectivoPago) {
                        // Solo autoseleccionar si hay un único método digital disponible
                        optionPago.selected = true;
                    }
                    metodoPagoSelect.appendChild(optionPago);
                });

                // Limpiar y rellenar método de cobro
                metodoCobroSelect.innerHTML = '';

                // Agregar opción vacía si hay múltiples métodos digitales
                const metodosCobroDigitales = data.medios_cobro.filter(medio => medio.id !== 'efectivo');
                if (metodosCobroDigitales.length > 1) {
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = 'Seleccione método de cobro';
                    metodoCobroSelect.appendChild(emptyOption);
                }

                data.medios_cobro.forEach((medio, index) => {
                    const optionCobro = document.createElement('option');
                    optionCobro.value = medio.id;
                    optionCobro.textContent = `${medio.nombre} (${medio.comision}%)`;
                    optionCobro.dataset.comision = medio.comision;

                    // Solo autoseleccionar si hay efectivo O si hay solo un método digital
                    if (medio.id === 'efectivo') {
                        optionCobro.selected = true;
                    } else if (metodosCobroDigitales.length === 1 && index === 0) {
                        // Solo autoseleccionar si hay un único método digital disponible
                        optionCobro.selected = true;
                    }
                    metodoCobroSelect.appendChild(optionCobro);
                });

            } catch (error) {
                console.error('Error loading medios de pago:', error);
                resetMediosPago();
            }
        }

        function resetMediosPago() {
            const tipo = getTipoOperacion();
            if (tipo === 'compra') {
                // Para compra, no mostrar efectivo por defecto
                metodoPagoSelect.innerHTML = '<option value="">Seleccione método de pago</option>';
            } else {
                // Para venta, sí mostrar efectivo
                metodoPagoSelect.innerHTML = '<option value="efectivo" selected>Efectivo</option>';
            }
            metodoCobroSelect.innerHTML = '<option value="efectivo" selected>Efectivo</option>';
        }

        // Realizar simulación
        async function performSimulation() {
            const monto = parseInputNumber(montoInput.value);
            const divisa = divisaSelect.value;
            const tipo = getTipoOperacion();

            // Validar que el monto sea un número entero
            if (montoInput.value && !Number.isInteger(parseFloat(montoInput.value))) {
                resultsCard.classList.add('hidden');
                return;
            }

            if (monto < 1 || !divisa) {
                resultsCard.classList.add('hidden');
                return;
            }

            const params = new URLSearchParams({
                monto: monto.toString(),
                divisa_seleccionada: divisa,
                tipo_operacion: tipo,
                metodo_pago: metodoPagoSelect.value,
                metodo_cobro: metodoCobroSelect.value
            });

            try {
                const response = await fetch(`{% url "transacciones:api_simular_cambio" %}?${params.toString()}`);
                const data = await response.json();

                // Guardar datos para el modal
                lastSimulationData = data;

                // Actualizar resultados
                // Mostrar montos con formato y énfasis
                const tipo = getTipoOperacion();

                montoOriginalVal.textContent = formatNumberWithCurrency(data.monto_original, data.moneda_origen);
                monedaOrigenVal.textContent = data.moneda_origen;


                if (tipo === 'compra') {

                    tasaVal.textContent = `1 ${data.moneda_origen} = ${formatRate(data.tasa_cambio)} PYG`;
                } else {

                    tasaVal.textContent = `1 ${data.moneda_origen} = ${formatRate(data.tasa_cambio)} PYG`;
                }

                montoFinalVal.innerHTML = `<span class="text-xl font-extrabold text-primary">${formatNumberWithCurrency(data.total, "PYG")}</span>`;
                monedaDestinoVal.textContent = "PYG";
                comisionBaseVal.textContent = formatNumberWithCurrency(data.comision_base, data.moneda_destino);
                descuentoVal.textContent = data.descuento;
                comisionFinalVal.textContent = formatNumberWithCurrency(data.comision_final, data.moneda_destino);

                // Mostrar comisión de medio de pago si aplica
                const metodoPago = metodoPagoSelect.value;
                const isStripePayment = metodoPago === 'stripe_new' || metodoPago.startsWith('stripe_');

                if (isStripePayment) {
                    // Para Stripe, mostrar desglose detallado
                    comisionMedioPagoSection.classList.add('hidden');
                    stripeFeeSection.classList.remove('hidden');

                    // Comisión variable (2.9%)
                    stripeVariableFee.textContent = formatNumberWithCurrency(data.comision_medio_pago_monto, "PYG");

                    // Comisión fija (0.30 USD en PYG)
                    stripeFixedFee.textContent = formatNumberWithCurrency(data.stripe_fixed_fee, "PYG");

                    // Total Stripe
                    const totalStripeFee = data.comision_medio_pago_monto + data.stripe_fixed_fee;
                    stripeTotalFee.textContent = formatNumberWithCurrency(totalStripeFee, "PYG");

                } else if (data.comision_medio_pago_monto > 0) {
                    // Para otros medios de pago
                    comisionMedioPagoSection.classList.remove('hidden');
                    stripeFeeSection.classList.add('hidden');
                    comisionMedioPagoVal.textContent = formatNumberWithCurrency(data.comision_medio_pago_monto, data.moneda_destino);
                    comisionMedioPagoPct.textContent = data.comision_medio_pago_porcentaje;
                } else {
                    comisionMedioPagoSection.classList.add('hidden');
                    stripeFeeSection.classList.add('hidden');
                }

                // Actualizar comisiones en el panel colapsable
                const cb = document.getElementById('commission-breakdown');
                if (cb) {
                    cb.querySelector('#comision-base-val').textContent = formatNumberWithCurrency(data.comision_base, data.moneda_destino);
                    cb.querySelector('#descuento-val').textContent = data.descuento;
                    cb.querySelector('#comision-final-val').textContent = formatNumberWithCurrency(data.comision_final, data.moneda_destino);
                    if (data.comision_medio_pago_monto > 0) {
                        cb.querySelector('#comision-medio-pago-section').classList.remove('hidden');
                        cb.querySelector('#comision-medio-pago-val').textContent = formatNumberWithCurrency(data.comision_medio_pago_monto, data.moneda_destino);
                        cb.querySelector('#comision-medio-pago-pct').textContent = data.comision_medio_pago_porcentaje;
                    } else {
                        cb.querySelector('#comision-medio-pago-section').classList.add('hidden');
                    }
                }

                // Mostrar advertencia de billeteras
                const metodoCobro = metodoCobroSelect.value;
                if (metodoPago.includes('billetera') || metodoCobro.includes('billetera')) {
                    walletWarning.classList.remove('hidden');
                } else {
                    walletWarning.classList.add('hidden');
                }

                // Habilitar botón proceder si hay cliente seleccionado
                if (proceedBtn) {
                    proceedBtn.disabled = !currentCliente;
                }

                resultsCard.classList.remove('hidden');

            } catch (error) {
                console.error('Error performing simulation:', error);
                resultsCard.classList.add('hidden');
            }
        }

        // Mostrar modal de confirmación
        function showConfirmationModal() {
            if (!lastSimulationData) return;

            const tipo = getTipoOperacion();
            const tipoText = tipo === 'compra' ? 'Compra' : 'Venta';
            const divisa = divisaSelect.options[divisaSelect.selectedIndex].text;
            const metodoPago = metodoPagoSelect.options[metodoPagoSelect.selectedIndex].text;
            const metodoCobro = metodoCobroSelect.options[metodoCobroSelect.selectedIndex].text;

            // Actualizar labels dinámicos según el tipo de operación
            const divisaLabel = document.getElementById('modal-divisa-label');
            const totalLabel = document.getElementById('modal-total-label');

            if (tipo === 'compra') {
                divisaLabel.textContent = 'Divisa a Comprar:';
                totalLabel.textContent = 'Total a Pagar:';
            } else {
                divisaLabel.textContent = 'Divisa a Vender:';
                totalLabel.textContent = 'Total a Recibir:';
            }

            // Obtener información de comisiones de los métodos
            const comisionPago = lastSimulationData.comision_medio_pago_porcentaje || 0;
            const comisionCobro = lastSimulationData.comision_medio_cobro_porcentaje || 0;

            // Actualizar contenido
            document.getElementById('modal-tipo').textContent = tipoText;
            document.getElementById('modal-divisa').textContent = divisa;
            document.getElementById('modal-monto').textContent = `${formatNumberWithCurrency(lastSimulationData.monto_original, lastSimulationData.moneda_origen)} ${lastSimulationData.moneda_origen}`;
            document.getElementById('modal-total').textContent = `${formatNumberWithCurrency(lastSimulationData.total, "PYG")} PYG`;
            document.getElementById('modal-metodo-pago').textContent = metodoPago;
            document.getElementById('modal-metodo-cobro').textContent = metodoCobro;

            confirmationModal.classList.add('modal-open');
        }

        // Confirmar transacción
        async function confirmTransaction() {
            if (!lastSimulationData) return;

            // Verificar si el método de pago es Stripe
            const metodoPago = metodoPagoSelect.value;
            if (metodoPago === 'stripe_new' || metodoPago.startsWith('stripe_')) {
                // Cerrar modal de confirmación y mostrar modal de Stripe
                confirmationModal.classList.remove('modal-open');
                await showStripePaymentModal();
                return;
            }

            // Show loading state
            confirmBtn.textContent = 'Procesando...';
            confirmBtn.disabled = true;

            try {
                // Cambiar a GET con parámetros en la URL
                const params = new URLSearchParams({
                    tipo_operacion: getTipoOperacion(),
                    divisa_seleccionada: divisaSelect.value,
                    monto: parseInputNumber(montoInput.value),
                    metodo_pago: metodoPagoSelect.value,
                    metodo_cobro: metodoCobroSelect.value
                });

                const response = await fetch(`{% url "transacciones:api_crear_transaccion" %}?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Redirigir a la página de procesamiento con parámetros
                    const redirectParams = new URLSearchParams({
                        metodo_pago: metodoPagoSelect.value,
                        metodo_cobro: metodoCobroSelect.value
                    });
                    window.location.href = `${data.redirect_url}?${redirectParams.toString()}`;
                } else if (data.error === 'MFA_REQUIRED') {
                    // Se requiere verificación MFA - redirigir a la vista Django
                    window.location.href = data.redirect_url;
                } else {
                    showError('Error al crear la transacción: ' + (data.error || 'Error desconocido'));
                }

            } catch (error) {
                console.error('Error confirming transaction:', error);
                showError('Error al procesar la transacción. Intente nuevamente.');
            } finally {
                // Reset button state
                confirmBtn.textContent = 'Confirmar Transacción';
                confirmBtn.disabled = false;
                confirmationModal.classList.remove('modal-open');
            }
        }

        // Función para mostrar errores
        function showError(message) {
            // Crear y mostrar un toast de error
            const toast = document.createElement('div');
            toast.className = 'toast toast-top toast-end';
            toast.innerHTML = `
                <div class="alert alert-error">
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(toast);

            // Remover el toast después de 5 segundos
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 5000);
        }

        // ===== FUNCIONES DE STRIPE =====

        // Mostrar modal de pago Stripe
        async function showStripePaymentModal() {
            try {
                // Crear transacción primero
                const params = new URLSearchParams({
                    tipo_operacion: getTipoOperacion(),
                    divisa_seleccionada: divisaSelect.value,
                    monto: parseInputNumber(montoInput.value),
                    metodo_pago: metodoPagoSelect.value,
                    metodo_cobro: metodoCobroSelect.value
                });

                const response = await fetch(`{% url "transacciones:api_crear_transaccion" %}?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });

                const data = await response.json();

                if (!data.success) {
                    if (data.error === 'MFA_REQUIRED') {
                        window.location.href = data.redirect_url;
                        return;
                    }
                    showError('Error al crear la transacción: ' + (data.error || 'Error desconocido'));
                    return;
                }

                // Guardar ID de transacción
                currentTransactionId = data.transaccion_id;

                // Actualizar información del modal con datos de la simulación
                const montoTransaccion = lastSimulationData.total_antes_comision_medio;
                const comisionVariable = lastSimulationData.comision_medio_pago_monto;
                const comisionFija = lastSimulationData.stripe_fixed_fee;
                const totalComisiones = comisionVariable + comisionFija;
                const granTotal = lastSimulationData.total;

                // Actualizar elementos del modal
                stripeAmountDisplay.textContent = `${formatNumberWithCurrency(montoTransaccion, "PYG")} PYG`;
                stripeModalVariableFee.textContent = `${formatNumberWithCurrency(comisionVariable, "PYG")} PYG`;
                stripeModalFixedFee.textContent = `${formatNumberWithCurrency(comisionFija, "PYG")} PYG`;
                stripeModalTotalFees.textContent = `${formatNumberWithCurrency(totalComisiones, "PYG")} PYG`;
                stripeModalGrandTotal.textContent = `${formatNumberWithCurrency(granTotal, "PYG")} PYG`;

                // Limpiar errores previos
                hideStripeError();

                // Mostrar modal
                stripeModal.classList.add('modal-open');

            } catch (error) {
                console.error('Error showing Stripe modal:', error);
                showError('Error al iniciar el proceso de pago. Intente nuevamente.');
            }
        }

        // Ocultar error de Stripe
        function hideStripeError() {
            stripeErrorDiv.style.display = 'none';
            stripeErrorMessage.textContent = '';
        }

        // Mostrar error de Stripe
        function showStripeError(message) {
            stripeErrorMessage.textContent = message;
            stripeErrorDiv.style.display = 'block';
        }

        // Manejar envío del formulario de Stripe
        stripeForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            console.log('=== STRIPE PAYMENT FORM SUBMITTED ===');
            console.log('Current transaction ID:', currentTransactionId);
            console.log('Stripe object:', stripe);
            console.log('Card element:', stripeCardElement);

            if (!currentTransactionId) {
                console.error('No transaction ID found');
                showStripeError('Error: No se ha creado la transacción.');
                return;
            }

            // Mostrar loading
            stripeLoading.style.display = 'inline-block';
            confirmStripeBtn.disabled = true;
            hideStripeError();

            try {
                console.log('Starting Stripe payment process for transaction:', currentTransactionId);

                // Crear Payment Intent
                const intentResponse = await fetch('{% url "transacciones:stripe_create_payment_intent" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        transaccion_id: currentTransactionId
                    })
                });

                console.log('Intent response status:', intentResponse.status);

                if (!intentResponse.ok) {
                    throw new Error(`HTTP error! status: ${intentResponse.status}`);
                }

                const intentData = await intentResponse.json();
                console.log('Intent data received:', intentData);

                if (!intentData.success) {
                    console.error('Payment intent creation failed:', intentData.error);
                    showStripeError(intentData.error || 'Error al procesar el pago.');
                    return;
                }

                console.log('Confirming card payment with Stripe...');
                // Confirmar pago con Stripe
                const {error} = await stripe.confirmCardPayment(intentData.client_secret, {
                    payment_method: {
                        card: stripeCardElement,
                        billing_details: {
                            // Aquí podrías agregar más detalles del cliente si están disponibles
                        },
                    }
                });

                if (error) {
                    console.error('Stripe confirmation error:', error);
                    showStripeError(error.message);
                    return;
                }

                console.log('Card payment confirmed, now confirming with backend...');
                // Confirmar pago en el backend
                const confirmResponse = await fetch('{% url "transacciones:stripe_confirm_payment" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        payment_intent_id: intentData.payment_intent_id
                    })
                });

                console.log('Confirm response status:', confirmResponse.status);

                if (!confirmResponse.ok) {
                    throw new Error(`HTTP error! status: ${confirmResponse.status}`);
                }

                const confirmData = await confirmResponse.json();
                console.log('Confirm data received:', confirmData);

                if (confirmData.success && confirmData.payment_status === 'succeeded') {
                    // Pago exitoso - redirigir
                    showSuccess('¡Pago procesado exitosamente!');
                    setTimeout(() => {
                        window.location.href = `/transacciones/procesar/${currentTransactionId}/`;
                    }, 1500);
                } else {
                    showStripeError(confirmData.error || 'Error al confirmar el pago.');
                }

            } catch (error) {
                console.error('Error processing Stripe payment:', error);
                showStripeError('Error de conexión. Intente nuevamente.');
            } finally {
                // Ocultar loading
                stripeLoading.style.display = 'none';
                confirmStripeBtn.disabled = false;
            }
        });

        // Función para mostrar éxito
        function showSuccess(message) {
            const toast = document.createElement('div');
            toast.className = 'toast toast-top toast-end';
            toast.innerHTML = `
                <div class="alert alert-success">
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                document.body.removeChild(toast);
            }, 5000);
        }

        // Cerrar modal de Stripe
        cancelStripeBtn.addEventListener('click', function() {
            stripeModal.classList.remove('modal-open');
            hideStripeError();
        });

        // ===== FIN FUNCIONES DE STRIPE =====

        // Event listeners
        tipoOperacionInputs.forEach(input => {
            input.addEventListener('change', function() {
                updateLabelsLocal();
                // Recargar medios de pago porque las opciones de cobro cambian según el tipo
                if (currentCliente) {
                    loadMediosPago();
                }
                performSimulation();
            });
        });

        divisaSelect.addEventListener('change', performSimulation);

        // Event listeners para formateo en tiempo real del input de monto
        montoInput.addEventListener('input', function(e) {
            const value = e.target.value;
            const montoError = document.getElementById('monto-error');

            // Validar si es un número entero
            if (value && !Number.isInteger(parseFloat(value))) {
                // Mostrar error y cambiar estilo del input
                montoError.classList.remove('hidden');
                e.target.classList.remove('input-bordered');
                e.target.classList.add('input-error');

                // No borrar el valor, mantenerlo para que el usuario pueda corregirlo
                return;
            } else {
                // Ocultar error y restaurar estilo normal
                montoError.classList.add('hidden');
                e.target.classList.remove('input-error');
                e.target.classList.add('input-bordered');
            }

            performSimulation();
        });

        // Prevenir caracteres no válidos
        montoInput.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.which);
            if (!/[\d, ]/.test(char) && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
            }
        });

        metodoPagoSelect.addEventListener('change', performSimulation);
        metodoCobroSelect.addEventListener('change', performSimulation);

        // Event listener para el botón de realizar transacción
        if (proceedBtn) {
            proceedBtn.addEventListener('click', showConfirmationModal);
        }

        // Event listeners para el modal
        confirmBtn.addEventListener('click', confirmTransaction);

        // Función para cerrar modal
        function closeModal() {
            confirmationModal.classList.remove('modal-open');
        }

        // Event listeners para cerrar modal
        cancelBtn.addEventListener('click', closeModal);
        closeModalBtn.addEventListener('click', closeModal);

        // Cerrar modal al hacer clic fuera
        confirmationModal.addEventListener('click', function(e) {
            if (e.target === confirmationModal) {
                closeModal();
            }
        });

        // Cerrar modal con tecla Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && confirmationModal.classList.contains('modal-open')) {
                closeModal();
            }
        });



        // Inicialización
        updateLabelsLocal();
        loadDivisasLocal();
        if (currentCliente) {
            loadMediosPago();
        }
    })();
        </script>
    </div>
{% endblock content %}
